!function(e,t){"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(exports=module.exports=t(e,exports)):"function"==typeof define&&define.amd?define(["exports"],function(a){e.Lockr=t(e,a)}):e.Lockr=t(e,{})}(this,function(e,t){"use strict";return Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length>>>0,a=Number(arguments[1])||0;for(a=0>a?Math.ceil(a):Math.floor(a),0>a&&(a+=t);t>a;a++)if(a in this&&this[a]===e)return a;return-1}),t.prefix="",t._getPrefixedKey=function(e,t){return t=t||{},t.noPrefix?e:this.prefix+e},t.set=function(e,t,a){var n=this._getPrefixedKey(e,a);try{localStorage.setItem(n,JSON.stringify({data:t}))}catch(i){console&&console.warn("Lockr didn't successfully save the '{"+e+": "+t+"}' pair, because the localStorage is full.")}},t.get=function(e,t,a){var n,i=this._getPrefixedKey(e,a);try{n=JSON.parse(localStorage.getItem(i))}catch(o){n=localStorage[i]?JSON.parse('{"data":"'+localStorage.getItem(i)+'"}'):null}return null===n?t:"object"==typeof n&&"undefined"!=typeof n.data?n.data:n||t},t.sadd=function(e,a,n){var i,o=this._getPrefixedKey(e,n),s=t.smembers(e);if(s.indexOf(a)>-1)return null;try{s.push(a),i=JSON.stringify({data:s}),localStorage.setItem(o,i)}catch(r){console.log(r),console&&console.warn("Lockr didn't successfully add the "+a+" to "+e+" set, because the localStorage is full.")}},t.smembers=function(e,t){var a,n=this._getPrefixedKey(e,t);try{a=JSON.parse(localStorage.getItem(n))}catch(i){a=null}return null===a?[]:a.data||[]},t.sismember=function(e,a,n){this._getPrefixedKey(e,n);return t.smembers(e).indexOf(a)>-1},t.getAll=function(){var e=Object.keys(localStorage);return e.map(function(e){return t.get(e)})},t.srem=function(e,a,n){var i,o,s=this._getPrefixedKey(e,n),r=t.smembers(e,a);o=r.indexOf(a),o>-1&&r.splice(o,1),i=JSON.stringify({data:r});try{localStorage.setItem(s,i)}catch(p){console&&console.warn("Lockr couldn't remove the "+a+" from the set "+e)}},t.rm=function(e){localStorage.removeItem(e)},t.flush=function(){localStorage.clear()},t}),function(){function e(){I.keyboardSupport&&m("keydown",i)}function t(){if(!E&&document.body){E=!0;var t=document.body,a=document.documentElement,n=window.innerHeight,i=t.scrollHeight;if(j=document.compatMode.indexOf("CSS")>=0?a:t,w=t,e(),top!=self)q=!0;else if(i>n&&(t.offsetHeight<=n||a.offsetHeight<=n)){var o=document.createElement("div");o.style.cssText="position:absolute; z-index:-10000; top:0; left:0; right:0; height:"+j.scrollHeight+"px",document.body.appendChild(o);var s,r=function(){s||(s=setTimeout(function(){C||(o.style.height="0",o.style.height=j.scrollHeight+"px",s=null)},500))};setTimeout(r,10);var p={attributes:!0,childList:!0,characterData:!1};if(k=new R(r),k.observe(t,p),j.offsetHeight<=n){var d=document.createElement("div");d.style.clear="both",t.appendChild(d)}}I.fixedBackground||C||(t.style.backgroundAttachment="scroll",a.style.backgroundAttachment="scroll")}}function a(e,t,a){if(u(t,a),1!=I.accelerationMax){var n=Date.now(),i=n-A;if(i<I.accelerationDelta){var o=(1+50/i)/2;o>1&&(o=Math.min(o,I.accelerationMax),t*=o,a*=o)}A=Date.now()}if(D.push({x:t,y:a,lastX:0>t?.99:-.99,lastY:0>a?.99:-.99,start:Date.now()}),!P){var s=e===document.body,r=function(){for(var n=Date.now(),i=0,o=0,p=0;p<D.length;p++){var d=D[p],l=n-d.start,_=l>=I.animationTime,m=_?1:l/I.animationTime;I.pulseAlgorithm&&(m=y(m));var c=d.x*m-d.lastX>>0,u=d.y*m-d.lastY>>0;i+=c,o+=u,d.lastX+=c,d.lastY+=u,_&&(D.splice(p,1),p--)}s?window.scrollBy(i,o):(i&&(e.scrollLeft+=i),o&&(e.scrollTop+=o)),t||a||(D=[]),D.length?Q(r,e,1e3/I.frameRate+1):P=!1};Q(r,e,0),P=!0}}function n(e){E||t();var n=e.target,i=p(n);if(!i||e.defaultPrevented||e.ctrlKey)return!0;if(c(w,"embed")||c(n,"embed")&&/\.pdf/i.test(n.src)||c(w,"object"))return!0;var o=-e.wheelDeltaX||e.deltaX||0,r=-e.wheelDeltaY||e.deltaY||0;return O&&(e.wheelDeltaX&&h(e.wheelDeltaX,120)&&(o=-120*(e.wheelDeltaX/Math.abs(e.wheelDeltaX))),e.wheelDeltaY&&h(e.wheelDeltaY,120)&&(r=-120*(e.wheelDeltaY/Math.abs(e.wheelDeltaY)))),o||r||(r=-e.wheelDelta||0),1===e.deltaMode&&(o*=40,r*=40),!I.touchpadSupport&&f(r)?!0:(Math.abs(o)>1.2&&(o*=I.stepSize/120),Math.abs(r)>1.2&&(r*=I.stepSize/120),a(i,o,r),e.preventDefault(),void s())}function i(e){var t=e.target,n=e.ctrlKey||e.altKey||e.metaKey||e.shiftKey&&e.keyCode!==M.spacebar;document.contains(w)||(w=document.activeElement);var i=/^(textarea|select|embed|object)$/i,o=/^(button|submit|radio|checkbox|file|color|image)$/i;if(i.test(t.nodeName)||c(t,"input")&&!o.test(t.type)||c(w,"video")||b(e)||t.isContentEditable||e.defaultPrevented||n)return!0;if((c(t,"button")||c(t,"input")&&o.test(t.type))&&e.keyCode===M.spacebar)return!0;var r,d=0,l=0,_=p(w),m=_.clientHeight;switch(_==document.body&&(m=window.innerHeight),e.keyCode){case M.up:l=-I.arrowScroll;break;case M.down:l=I.arrowScroll;break;case M.spacebar:r=e.shiftKey?1:-1,l=-r*m*.9;break;case M.pageup:l=.9*-m;break;case M.pagedown:l=.9*m;break;case M.home:l=-_.scrollTop;break;case M.end:var u=_.scrollHeight-_.scrollTop-m;l=u>0?u+10:0;break;case M.left:d=-I.arrowScroll;break;case M.right:d=I.arrowScroll;break;default:return!0}a(_,d,l),e.preventDefault(),s()}function o(e){w=e.target}function s(){clearTimeout($),$=setInterval(function(){z={}},1e3)}function r(e,t){for(var a=e.length;a--;)z[H(e[a])]=t;return t}function p(e){var t=[],a=document.body,n=j.scrollHeight;do{var i=z[H(e)];if(i)return r(t,i);if(t.push(e),n===e.scrollHeight){var o=l(j)&&l(a),s=o||_(j);if(q&&d(j)||!q&&s)return r(t,U())}else if(d(e)&&_(e))return r(t,e)}while(e=e.parentElement)}function d(e){return e.clientHeight+10<e.scrollHeight}function l(e){var t=getComputedStyle(e,"").getPropertyValue("overflow-y");return"hidden"!==t}function _(e){var t=getComputedStyle(e,"").getPropertyValue("overflow-y");return"scroll"===t||"auto"===t}function m(e,t){window.addEventListener(e,t,!1)}function c(e,t){return(e.nodeName||"").toLowerCase()===t.toLowerCase()}function u(e,t){e=e>0?1:-1,t=t>0?1:-1,(S.x!==e||S.y!==t)&&(S.x=e,S.y=t,D=[],A=0)}function f(e){return e?(N.length||(N=[e,e,e]),e=Math.abs(e),N.push(e),N.shift(),clearTimeout(T),T=setTimeout(function(){window.localStorage&&(localStorage.SS_deltaBuffer=N.join(","))},1e3),!g(120)&&!g(100)):void 0}function h(e,t){return Math.floor(e/t)==e/t}function g(e){return h(N[0],e)&&h(N[1],e)&&h(N[2],e)}function b(e){var t=e.target,a=!1;if(-1!=document.URL.indexOf("www.youtube.com/watch"))do if(a=t.classList&&t.classList.contains("html5-video-controls"))break;while(t=t.parentNode);return a}function v(e){var t,a,n;return e*=I.pulseScale,1>e?t=e-(1-Math.exp(-e)):(a=Math.exp(-1),e-=1,n=1-Math.exp(-e),t=a+n*(1-a)),t*I.pulseNormalize}function y(e){return e>=1?1:0>=e?0:(1==I.pulseNormalize&&(I.pulseNormalize/=v(1)),v(e))}var w,k,$,T,x={frameRate:150,animationTime:200,stepSize:100,pulseAlgorithm:!0,pulseScale:4,pulseNormalize:1,accelerationDelta:20,accelerationMax:1,keyboardSupport:!0,arrowScroll:50,touchpadSupport:!0,fixedBackground:!0,excluded:""},I=x,C=!1,q=!1,S={x:0,y:0},E=!1,j=document.documentElement,N=[],O=/^Mac/.test(navigator.platform),M={left:37,up:38,right:39,down:40,spacebar:32,pageup:33,pagedown:34,end:35,home:36},I=x,D=[],P=!1,A=Date.now(),H=function(){var e=0;return function(t){return t.uniqueID||(t.uniqueID=e++)}}(),z={};window.localStorage&&localStorage.SS_deltaBuffer&&(N=localStorage.SS_deltaBuffer.split(","));var L,Q=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e,t,a){window.setTimeout(e,a||1e3/60)}}(),R=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,U=function(){var e;return function(){if(!e){var t=document.createElement("div");t.style.cssText="height:10000px;width:1px;",document.body.appendChild(t);{var a=document.body.scrollTop;document.documentElement.scrollTop}window.scrollBy(0,1),e=document.body.scrollTop!=a?document.body:document.documentElement,window.scrollBy(0,-1),document.body.removeChild(t)}return e}}();"onwheel"in document.createElement("div")?L="wheel":"onmousewheel"in document.createElement("div")&&(L="mousewheel"),L&&(m(L,n),m("mousedown",o),m("load",t))}();var ITEM=function(){};ITEM.prototype.getName=function(e){return e=e||_g.lang,this.name?this.name[e]||this.name:null};var Ship=function(e){$.extend(!0,this,e)};Ship.prototype=Object.create(ITEM.prototype),Ship.prototype.getName=function(e,t){return e=e||"",t=t||_g.lang,(this.name[t]||this.name.ja_jp)+(this.name.suffix?e+(_g.data.ship_namesuffix[this.name.suffix][t]||_g.data.ship_namesuffix[this.name.suffix].ja_jp):"")},Ship.prototype.getType=function(e){return e=e||_g.lang,this.type?_g.data.ship_types[this.type].full_zh:null};var Equipment=function(e){$.extend(!0,this,e)};Equipment.prototype=Object.create(ITEM.prototype),Equipment.prototype.getName=function(e,t){t=t||_g.lang;var a=ITEM.prototype.getName.call(this,t),n=e&&!e==!0?e:"small";return e?a.replace(/（([^（^）]+)）/g,"<"+n+">($1)</"+n+">"):a},Equipment.prototype.getType=function(e){return e=e||_g.lang,this.type?_g.data.item_types[this.type].name[e]:null},Equipment.prototype.getIconId=function(){return _g.data.item_types[this.type].icon},node.require("fs"),node.require("nedb"),node.require("mkdirp"),node.require("request"),node.require("request-progress"),node.require("semver"),node.require("url");var Q=node.require("q"),markdown=node.require("markdown").markdown;_g.animate_duration_delay=320,_g.inputIndex=0,_g.lang="zh_cn",_g.joint="・",_g.path={db:node.path.join(_g.root,"/app-db/"),page:node.path.join(_g.root,"/app/page/"),bgimg_dir:node.path.join(_g.root,"/app/assets/images/homebg/"),pics:{ships:node.path.join(_g.root,"/pics/ships/"),items:node.path.join(_g.root,"/pics/items/")}},_g.pathMakeObj=function(e){for(var t in e)"object"==typeof e[t]?_g.pathMakeObj(e[t]):node.mkdirp.sync(e[t])},_g.pathMakeObj(_g.path),_g.data={entities:{},items:{},item_types:{},ships:{},ship_id_by_type:[],ship_types:{},ship_type_order:{},ship_classes:{}};var _db={fleets:new node.nedb({filename:node.path.join(node.gui.App.dataPath,"NeDB/fleets.json")})};_g.ship_type_order=[],_g.ship_type_order_map={},_g.statSpeed={5:"低速",10:"高速"},_g.statRange={1:"短",2:"中",3:"长",4:"超长"},_g.getStatSpeed=function(e){return e=parseInt(e),_g.statSpeed[e]},_g.getStatRange=function(e){return e=parseInt(e),_g.statRange[e]},_g.log=function(e){debugmode&&console.log(e)},_frame.app_main={page:{},page_dom:{},bgimgs:[],loading:["dbs","bgimgs","db_namesuffix"],functions_on_ready:[],loaded:function(e,t){if(e){var a=_frame.app_main.loading.indexOf(e);a>-1&&(_frame.app_main.loading.splice(_frame.app_main.loading.indexOf(e),1),_frame.app_main.is_loaded=!1)}_frame.app_main.loading.length||_frame.app_main.is_loaded||(setTimeout(function(){!_frame.app_main.is_loaded||_frame.app_main.loading.length||$html.hasClass("app-ready")||(_frame.dom.layout.addClass("ready"),$html.addClass("app-ready"),setTimeout(function(){for(var e in _frame.app_main.functions_on_ready)_frame.app_main.functions_on_ready[e]()},1500))},t?300:1e3),this.window_event_bound||($window.on("popstate._global",function(e){if(e.originalEvent&&e.originalEvent.state)_frame.app_main.state(e.originalEvent.state);else{var t=location.search?location.search.split("?")[1]:"",a={};t=t.split("&");for(var n=0;n<t.length;n++){var i=t[n].split("=");a[i[0]]=i[1]||!0}_frame.app_main.window_event_bound||a.page||a.infos||_frame.app_main.load_page(Lockr.get("last_page",_frame.app_main.nav[0].page)),_frame.app_main.state(a)}}).trigger("popstate._global"),this.window_event_bound=!0),_frame.app_main.is_loaded=!0)},pushState:function(e,t,a){history.pushState(e,t,a),e.infos||_frame.infos.hide()},state:function(e){e.infos?_frame.infos.show_func(e.infos,e.id,null,e.infosHistoryIndex):_frame.infos.hide(),e.page&&this.load_page_func(e.page)},change_bgimg:function(e){function t(e){setTimeout(function(){e.remove()},_g.animate_duration_delay)}if(!_frame.app_main.bgimgs.length)return!1;var a=e&&e.length?e:_frame.app_main.bgimgs,n=a[_g.randInt(a.length)],i=_frame.app_main.cur_bgimg_el?_frame.app_main.cur_bgimg_el.css("background-image"):null;for(i=i?i.split("/"):null,i=i?i[i.length-1].split(")"):null,i=i?i[0]:null;n==i;)n=a[_g.randInt(a.length-1)];var o="file://"+encodeURI(node.path.join(_g.path.bgimg_dir,"/blured/"+n).replace(/\\/g,"/"));this.bgimg_path=node.path.join(_g.path.bgimg_dir,"/"+n),n="file://"+encodeURI(this.bgimg_path.replace(/\\/g,"/")),i&&t(_frame.app_main.cur_bgimg_el),_frame.app_main.cur_bgimg_el=$("<div/>").css("background-image","url("+n+")").appendTo(_frame.dom.bgimg).add($("<s"+(_frame.app_main.change_bgimg_fadein?' class="fadein"':"")+"/>").css("background-image","url("+o+")").appendTo(_frame.dom.nav)).add($("<s"+(_frame.app_main.change_bgimg_fadein?' class="fadein"':"")+"/>").css("background-image","url("+o+")").appendTo(_frame.dom.main)),_frame.dom.bg_controls&&(_frame.app_main.cur_bgimg_el=_frame.app_main.cur_bgimg_el.add($("<s"+(_frame.app_main.change_bgimg_fadein?' class="fadein"':"")+"/>").css("background-image","url("+o+")").appendTo(_frame.dom.bg_controls))),_frame.app_main.change_bgimg_fadein=!0},toggle_hidecontent:function(){_frame.dom.layout.toggleClass("hidecontent")},load_page:function(e){return _frame.app_main.cur_page!=e&&e?(this.pushState({page:e},null,"?page="+e),void this.load_page_func(e)):e},load_page_func:function(e){if(_g.log("PREPARE LOADING: "+e),_frame.app_main.cur_page==e||!e)return e;if(!_frame.app_main.page_dom[e]){_frame.app_main.page_dom[e]=$('<div class="page" page="'+e+'"/>').appendTo(_frame.dom.main);var t=node.fs.readFileSync(_g.path.page+e+".html","utf8");t&&(_frame.app_main.page_dom[e].html(t),_frame.app_main.page[e]&&_frame.app_main.page[e].init&&_frame.app_main.page[e].init(_frame.app_main.page_dom[e]),_p.initDOM(_frame.app_main.page_dom[e]))}_frame.app_main.page_dom[e].removeClass("off").trigger("pageon"),_frame.app_main.cur_page&&(_frame.dom.navs[_frame.app_main.cur_page].removeClass("on"),_frame.app_main.page_dom[_frame.app_main.cur_page].addClass("off").trigger("pageoff")),_frame.dom.navs[e].addClass("on"),_frame.dom.layout.hasClass("ready")&&_frame.app_main.change_bgimg(),_frame.app_main.cur_page=e,"about"!=e&&Lockr.set("last_page",e),_g.log("LOADED: "+e)},only_bg_on:function(){return this.only_bg?!0:(_frame.dom.bg_controls||(_frame.dom.bg_controls=$('<div class="bg_controls"/>').on("transitionend.only_bg_off",function(e){e.currentTarget==e.target&&"top"==e.originalEvent.propertyName&&_frame.dom.layout.hasClass("only_bg")&&$(this).offset().top>=$body.height()&&(_frame.dom.layout.removeClass("only_bg"),_frame.app_main.only_bg=!1)}).appendTo(_frame.dom.layout),_frame.app_main.cur_bgimg_el=_frame.app_main.cur_bgimg_el.add(_frame.app_main.cur_bgimg_el.eq(0).clone().appendTo(_frame.dom.bg_controls)),$('<button class="prev" icon="arrow-left"/>').on("click",function(){var e=node.path.parse(_frame.app_main.bgimg_path),t=$.inArray(e.base,_frame.app_main.bgimgs)-1;0>t&&(t=_frame.app_main.bgimgs.length-1),_frame.app_main.change_bgimg([_frame.app_main.bgimgs[t]])}).appendTo(_frame.dom.bg_controls),$('<button class="back"/>').html("返回").on("click",function(){_frame.app_main.only_bg_off()}).appendTo(_frame.dom.bg_controls),$('<button class="back"/>').html("保存图片").on("click",function(){var e=node.path.parse(_frame.app_main.bgimg_path),t=$.inArray(e.base,_frame.app_main.bgimgs);_g.file_save_as(_frame.app_main.bgimg_path,t+1+e.ext)}).appendTo(_frame.dom.bg_controls),$('<button class="next" icon="arrow-right"/>').on("click",function(){var e=node.path.parse(_frame.app_main.bgimg_path),t=$.inArray(e.base,_frame.app_main.bgimgs)+1;t>=_frame.app_main.bgimgs.length&&(t=0),_frame.app_main.change_bgimg([_frame.app_main.bgimgs[t]])}).appendTo(_frame.dom.bg_controls)),_frame.dom.layout.addClass("only_bg"),setTimeout(function(){_frame.dom.bg_controls.addClass("on")},10),void(this.only_bg=!0))},only_bg_off:function(){return this.only_bg?void _frame.dom.bg_controls.removeClass("on"):!0},only_bg_toggle:function(){return this.only_bg?this.only_bg_off():this.only_bg_on()},init:function(){if(_frame.app_main.is_init)return!0;if(_frame.dom.nav=$("<nav/>").appendTo(_frame.dom.layout),_frame.dom.logo=$('<button class="logo" />').on({"animationend, webkitAnimationEnd":function(){$(this).addClass("ready-animated")}}).appendTo(_frame.dom.nav),_frame.dom.navlinks=$("<div/>").appendTo(_frame.dom.nav),_frame.dom.globaloptions=$('<section class="options"/>').appendTo(_frame.dom.nav),_frame.dom.btnShowOnlyBg=$('<button class="show_only_bg" icon="images"/>').on("click",function(){_frame.app_main.only_bg_toggle()}).appendTo(_frame.dom.globaloptions),_frame.dom.btnShowOnlyBgBack=$('<button class="show_only_bg_back" icon="arrow-set2-left"/>').on("click",function(){_frame.app_main.only_bg_off()}).appendTo(_frame.dom.nav),_frame.dom.main=$("<main/>").appendTo(_frame.dom.layout),_frame.dom.bgimg=$('<div class="bgimg" />').appendTo(_frame.dom.layout),_frame.app_main.nav&&_frame.app_main.nav.length){_frame.dom.navs={};for(var e in _frame.app_main.nav){var t=_frame.app_main.nav[e];_frame.dom.navs[t.page]=function(e){return $("<button />").on("click",function(){_frame.app_main.load_page(e)})}(t.page).html(t.title).appendTo(_frame.dom.navlinks)}}var a=Q.fcall(function(){});a.then(function(){var e=Q.defer();return node.fs.readdir(_g.path.db,function(t,a){if(t)e.reject(new Error(t));else{for(var n in a)_db[node.path.parse(a[n]).name]=new node.nedb({filename:node.path.join(_g.path.db,"/"+a[n])});e.resolve(a)}}),e.promise}).then(function(){_g.log("背景图: START");var e=Q.defer();return node.fs.readdir(_g.path.bgimg_dir,function(t,a){if(t)e.reject(new Error(t));else{var n=_config.get("bgimgs"),i=[];n=n?n.split(","):[];for(var o in a){var s=node.fs.lstatSync(node.path.join(_g.path.bgimg_dir,"/"+a[o]));if(!s.isDirectory())if(_frame.app_main.bgimgs.push(a[o]),n.length)$.inArray(a[o],n)<0&&i.push(a[o]);else{var r=parseInt(s.ctime.valueOf());i.length?r>i[1]&&(i=[a[o],r]):i=[a[o],r]}}n.length||i.pop(),_config.set("bgimgs",_frame.app_main.bgimgs),_frame.app_main.change_bgimg(i),_frame.app_main.loaded("bgimgs"),_g.log("背景图: DONE"),e.resolve()}}),e.promise}).then(function(){_g.log("Preload All DBs: START");var e=[],t=[],a=0;for(var n in _db)t.push(n);return t.forEach(function(n){function i(e){_g.log("DB "+e+" DONE"),o.resolve(),a++,a>=t.length&&(_g.log("Preload All DBs: DONE"),setTimeout(function(){_frame.app_main.loaded("dbs")},100))}var o=Q.defer();_db[n].loadDatabase(function(e){if(e)o.reject(new Error(e));else switch(n){case"ships":i(n);break;case"ship_namesuffix":_db.ship_namesuffix.find({}).sort({id:1}).exec(function(e,t){e?o.reject(new Error(e)):(_g.data.ship_namesuffix=[{}].concat(t),_frame.app_main.loaded("db_namesuffix"),i(n))});break;case"ship_type_order":_db.ship_type_order.find({}).sort({id:1}).exec(function(e,t){if(e)o.reject(new Error(e));else{for(var a in t)_g.ship_type_order.push(t[a].types.length>1?t[a].types:t[a].types[0]),_g.data.ship_type_order[a]=t[a];!function(){for(var e in _g.ship_type_order){var t=parseInt(e);if("object"==typeof _g.ship_type_order[e])for(var a in _g.ship_type_order[e])_g.ship_type_order_map[_g.ship_type_order[e][a]]=t;else _g.ship_type_order_map[_g.ship_type_order[e]]=t}}(),_db.ships.find({}).sort({type:1,"class":1,class_no:1,time_created:1,"name.suffix":1}).exec(function(t,a){function s(e){for(var t=0;_g.data.ship_id_by_type[e]&&_g.data.ship_id_by_type[e][t];){var a,n=_g.data.ship_id_by_type[e][t];if(_g.data.ships[n].remodel_next&&_g.data.ships[_g.data.ships[n].remodel_next]&&_g.data.ships[n].remodel_next!=_g.data.ship_id_by_type[e][t+1]&&(a=$.inArray(_g.data.ships[n].remodel_next,_g.data.ship_id_by_type[e]))>-1){_g.log(n+", "+_g.data.ships[n].remodel_next+", "+a),_g.data.ship_id_by_type[e].splice(a,1),_g.data.ship_id_by_type[e].splice($.inArray(n,_g.data.ship_id_by_type[e])+1,0,_g.data.ships[n].remodel_next),console.log(_g.data.ship_id_by_type[e]),s(e);break}t>=_g.data.ship_id_by_type[e].length-2?(e++,t=0):t++}}if(t)o.reject(new Error(e));else{for(var r in a)_g.data.ships[a[r].id]=new Ship(a[r]),"undefined"==typeof _g.data.ship_id_by_type[_g.ship_type_order_map[a[r].type]]&&(_g.data.ship_id_by_type[_g.ship_type_order_map[a[r].type]]=[]),_g.data.ship_id_by_type[_g.ship_type_order_map[a[r].type]].push(a[r].id);s(0),i(n)}})}});break;case"updates":"undefined"==typeof _g.data[n]&&(_g.data[n]={}),i(n);break;case"arsenal_all":_g.data.arsenal_all=[],_db.arsenal_all.find({}).sort({sort:1}).exec(function(e,t){for(var a in t)_g.data.arsenal_all.push(t[a].id);i(n)});break;case"arsenal_weekday":_g.data.arsenal_weekday={},_db.arsenal_weekday.find({}).sort({weekday:1}).exec(function(e,t){for(var a in t)_g.data.arsenal_weekday[parseInt(a)]=t[a].improvements;i(n)});break;default:_db[n].find({},function(e,t){if(e)o.reject(new Error(e));else{"undefined"==typeof _g.data[n]&&(_g.data[n]={});for(var a in t)switch(n){case"items":_g.data[n][t[a].id]=new Equipment(t[a]);break;default:_g.data[n][t[a].id]=t[a]}i(n)}})}}),e.push(o.promise)}),Q.all(e)}).then(function(){var e=Q.defer();_g.data.item_id_by_type=[],_g.item_type_order=[];var t={},a={};for(var n in _g.data.item_type_collections)for(var i in _g.data.item_type_collections[n].types)t[_g.data.item_type_collections[n].types[i]]=n,_g.item_type_order.push(_g.data.item_type_collections[n].types[i]),a[_g.data.item_type_collections[n].types[i]]=_g.item_type_order.length-1;for(var n in _g.data.items){var o=a[_g.data.items[n].type];_g.data.item_id_by_type[o]||(_g.data.item_id_by_type[o]={collection:t[_g.data.items[n].type],equipments:[]}),_g.data.item_id_by_type[o].equipments.push(_g.data.items[n].id)}return setTimeout(function(){e.resolve()},100),e.promise}).then(function(){return _g.log("数据更新检查: START"),global.launcherOptions&&global.launcherOptions.dataUpdated?global.launcherOptions.dataUpdated:{}}).then(function(e){var t=[],a=[],n=0,i=$();for(var o in e){for(var s=e[o].split("."),r="",p=0;p<Math.min(3,s.length);p++)r+="."+s[p];r=r.substr(1),a.push({type:o,version:r})}return a.length?(a.forEach(function(e){function o(e){_g.log("数据更新检查: "+e+" DONE"),s.resolve(),n++,n>=a.length&&(i.length?(_g.log("数据更新检查: DONE"),_frame.app_main.functions_on_ready.push(function(){_frame.modal.show($('<div class="updates"/>').append(i).on("click.infosHideModal","[data-infos]",function(){_frame.modal.hide()}),"<span>更新日志</span>",{classname:"update_journal"})})):_g.log("数据更新检查: DONE，无更新日志"))}var s=Q.defer();_db.updates.find(e).sort({date:-1}).exec(function(t,a){if(t)s.reject(new Error(t));else{for(var n in a){var r=$('<section class="update_journal" data-version-'+a[n].type+'="'+a[n].version+'"/>').html(_frame.app_main.page.about.journaltitle(a[n]));try{$(_frame.app_main.page.about.journal_parse(a[n].journal)).appendTo(r)}catch(p){_g.error(p),r.remove()}i=i.add(r)}o(e.type+" - "+e.version)}}),t.push(s.promise)}),Q.all(t)):(_g.log("数据更新检查: DONE，无数据更新"),!1)}).then(function(){return!0}).then(function(){function e(e){var t=e.pushState;e.pushState=function(a){return"function"==typeof e.onpushstate&&e.onpushstate({state:a}),setTimeout(function(){_frame.dom.hashbar.trigger("urlchanged")},1),t.apply(e,arguments)}}return debugmode&&(_frame.dom.hashbar=$('<input type="text"/>').on({urlchanged:function(){$(this).val(location.href.substr((location.origin+location.pathname).length))},change:function(){location.replace(location.origin+location.pathname+_frame.dom.hashbar.blur().val())}}).appendTo($('<div class="debug_hashbar"/>').appendTo(_frame.dom.layout)).trigger("urlchanged"),_frame.dom.layout.addClass("debug-hashbar"),$window.on({"hashchange.debug_mode_hashbar":function(){_frame.dom.hashbar.trigger("urlchanged")},"popstate.debug_mode_hashbar":function(){_frame.dom.hashbar.trigger("urlchanged")}}),e(window.history)),!0}).catch(function(e){_g.error(e)}).done(function(){_g.log("Global initialization DONE")}),_frame.app_main.is_init=!0}},_g.error=function(e){throw e instanceof Error||(e=new Error(e)),_g.log(e),node.fs.appendFileSync(node.path.join(_g.execPath,"errorlog.txt"),new Date+"\r\n"+e.message+"\r\n\r\n========================================\r\n\r\n"),e};var _updater={local_versions:{},remote_root:"http://fleet.diablohu.com",remote_url:"http://fleet.diablohu.com/versions.json",remote_data:{}};_updater.get_local_version=function(){return _updater.local_versions=JSON.parse(localStorage["nwjs-data-version"]||"{}"),_updater.local_versions},_updater.get_remote=function(){var e=Q.defer();return node.request({uri:_updater.remote_url,method:"GET"},function(t,a,n){t?e.reject(new Error(t)):200!=a.statusCode?e.reject(new Error(a.statusCode)):(_updater.remote_data=JSON.parse(n||"{}")||{},e.resolve(_updater.remote_data))}),e.promise},_updater.get_packages_updated=function(){function e(e,t){var a,n;if(typeof e+typeof t!="stringstring")return!1;for(e=e.split("."),t=t.split("."),a=0,n=Math.max(e.length,t.length);n>a;a++){if(e[a]&&!t[a]&&parseInt(e[a])>0||parseInt(e[a])>parseInt(t[a]))return 1;if(t[a]&&!e[a]&&parseInt(t[a])>0||parseInt(e[a])<parseInt(t[a]))return-1}return 0}var t=[];for(var a in _updater.local_versions)if(_updater.remote_data.packages&&_updater.remote_data.packages[a]){var n=_updater.remote_data.packages[a].version?_updater.remote_data.packages[a].version:_updater.remote_data.packages[a];e(n,_updater.local_versions[a])>0&&t.push(a)}return t.sort(function(e,t){return _updater.remote_data.packages[e].bytes-_updater.remote_data.packages[t].bytes})},_updater.create_update_indicator=function(){_updater.update_indicator&&_updater.update_indicator.length||(_updater.update_indicator=$('<button class="update_progress" icon="stairs-up" data-tip="检测到新版本<br>更新中..."/>').appendTo(_frame.dom.globaloptions),_updater.update_indicator_bar=$("<s/>").appendTo(_updater.update_indicator))},_updater.update=function(){var e=Q.fcall(function(){}),t=node.path.dirname(process.execPath).split(node.path.sep),a="",n=!1;t="darwin"==process.platform||"nwjs"==t[t.length-1]&&"nw.exe"==node.path.basename(process.execPath)?process.cwd():node.path.dirname(process.execPath),a=node.path.join(t,"data"),e.then(function(){var e=Q.defer();return node.fs.lstat(a,function(t,a){t||!a.isDirectory()?e.reject("数据包目录不存在, 不进行自动更新"):(n=!0,e.resolve(!0))}),e.promise}).then(function(){var e=Q.defer();return node.fs.readdir(a,function(t,a){if(t)e.reject(t);else{var n=[];for(var i in a)".updated"==node.path.extname(a[i])&&n.push(a[i]);e.resolve(n)}}),e.promise}).then(function(e){var t=[];return e.forEach(function(e){var n=Q.defer();node.fs.unlink(node.path.join(a,e),function(){_g.log("已删除更新残留文件 "+e),n.resolve()}),t.push(n.promise)}),Q.all(t)}).then(_updater.get_local_version()).then(_updater.get_remote).then(_updater.get_packages_updated).then(function(e){if(!e.length)return _g.log("所有数据包均为最新"),!1;_g.log("自动更新过程开始 ("+e.join(", ")+")"),_updater.create_update_indicator();var t=Q.fcall(function(){}),n=0,i=0,o=0;e.forEach(function(s){!function(n,s){i+=_updater.remote_data.packages[n].bytes,t=t.then(function(){function t(e,t){t=t||"",-4048==e.errno||e.message.indexOf("not permitted")>-1?_g.log("    "+t+"权限不足"):(_g.log(e),_g.log("    "+t+"发生错误 ["+e.errno+"]: "+e.message))}var r=Q.defer(),p=!1,d=node.path.join(a,n+node.path.extname(_updater.remote_data.packages[n].path)+".updated"),l=node.path.join(a,n+node.path.extname(_updater.remote_data.packages[n].path));return _g.log(""),_g.log("========== "+s+"/"+e.length+" =========="),_g.log(""),_g.log("    "+n+" | 本地版本: "+_updater.local_versions[n]+" | 服务器版本: "+(_updater.remote_data.packages[n].version?_updater.remote_data.packages[n].version:_updater.remote_data.packages[n])),node["request-progress"](node.request({uri:node.url.format(_updater.remote_root+"/"+_updater.remote_data.packages[n].path),method:"GET"}).on("error",function(e){_g.log("    下载数据包出错"),node.fs.unlink(d,function(){r.reject(new Error(e))})}).on("response",function(e){200==e.statusCode&&parseInt(e.headers["content-length"])==_updater.remote_data.packages[n].bytes&&(p=!0)})).on("error",function(e){_g.log("    下载数据包出错"),node.fs.unlink(d,function(){r.reject(new Error(e))})}).on("progress",function(e){_updater.update_indicator.addClass("on"),_g.log("    "+e.received+" / "+e.total+" ("+e.percent+"%) | "+Math.floor((o+e.received)/i*100)+"%"),_updater.update_indicator_bar.css("width",Math.floor((o+e.received)/i*100)+"%")}).pipe(node.fs.createWriteStream(d).on("finish",function(){p?(o+=_updater.remote_data.packages[n].bytes,node.fs.unlink(l,function(e){e&&(t(e,"删除原有数据包"),_g.log("    跳过")),node.fs.rename(d,l,function(e){e?(t(e,"重命名新数据包"),_g.log("    跳过")):_g.log("    该数据包更新完成"),r.resolve()})})):(_g.log("    下载数据包出错"),node.fs.unlink(d,function(){r.resolve()}))}).on("error",function(e){t(e,"写入文件"),_g.log("    流程结束"),r.reject(new Error(e))})),r.promise})}(s,n),n++}),t=t.catch(function(e){_g.error(e),_g.log("自动更新失败"),_updater.update_indicator.removeClass("on")}).done(function(){_g.log(""),o>=i?(_g.log("========== "+e.length+"/"+e.length+" =========="),_g.log(""),_g.log("自动更新完毕"),_updater.update_indicator.addClass("done").data("tip","更新完成<br>请重新启动程序"),_updater.update_indicator_bar.css("width","")):(_g.log("========== "+e.length+"/"+e.length+" =========="),_g.log(""),_g.log("自动更新失败, 结束流程"),_updater.update_indicator.removeClass("on"))})}).catch(function(e){_g.error(e),_g.log("自动更新失败"),_updater.update_indicator&&_updater.update_indicator.length&&_updater.update_indicator.remove()}).done(function(){_g.log("自动更新过程初始化完毕")})},_frame.app_main.functions_on_ready.push(_updater.update),_tmpl.improvement=function(e,t,a,n){if("undefined"==typeof e)return!1;if("object"!=typeof e&&!(e=_g.data.items[e]))return!1;t=t||0,a=a||[0],n=n||!1;var i=e.improvement[t],o=i.upgrade?_g.data.items[i.upgrade[0]]:!1,s=[],r="";for(var p in a){var d=i.req[a[p]];d[1]&&(s=s.concat(d[1]))}if(s.length){var l=[];for(var p in s)l.push('<span data-infos="[[SHIP::'+s[p]+']]" data-tip="[[SHIP::'+s[p]+']]">'+_g.data.ships[s[p]].getName()+"</span>");r="<font>"+l.join(" / ")+"</font>"}else r='<font class="no">无秘书舰要求</font>';return _tmpl.export('<span class="improvement">'+_tmpl.improvement__title(e,o,i.upgrade[1])+r+_tmpl.improvement__resource(i,o?!0:!1)+"</span>",n)},_tmpl.improvement_detail=function(e,t){if("undefined"==typeof e)return!1;if("object"!=typeof e&&!(e=_g.data.items[e]))return!1;var a="";for(var n in e.improvement||[]){var i=e.improvement[n],o=i.upgrade?_g.data.items[i.upgrade[0]]:!1,s="<font>";for(var r in i.req){var p,d=i.req[r],l=[];s+="<b>";for(var _=0;7>_;_++){switch(_){case 0:p="日";break;case 1:p="一";break;case 2:p="二";break;case 3:p="三";break;case 4:p="四";break;case 5:p="五";break;case 6:p="六"}s+="<i"+(d[0][_]?' class="on"':"")+">"+p+"</i>"}if(d[1]){for(var _ in d[1])l.push('<span data-infos="[[SHIP::'+d[1][_]+']]" data-tip="[[SHIP::'+d[1][_]+']]">'+_g.data.ships[d[1][_]].getName()+"</span>");s+=l.join(" / ")}else s+="<b>无秘书舰要求</b>";s+="</b>"}s+="</font>",a+='<span class="improvement improvement-details">'+_tmpl.improvement__title(e,o,i.upgrade[1])+s+_tmpl.improvement__resource(i,o?!0:!1)+"</span>"}return _tmpl.export(a,t)},_tmpl.improvement__title=function(e,t,a){return'<strong><em style="background-image:url(../app/assets/images/itemicon/'+e.getIconId()+'.png)" data-infos="[[EQUIPMENT::'+e.id+']]" data-tip="[[EQUIPMENT::'+e.id+']]"">'+e.getName(!0)+"</em>"+(t?'<b></b><em style="background-image:url(../app/assets/images/itemicon/'+t.getIconId()+'.png)" data-infos="[[EQUIPMENT::'+t.id+']]" data-tip="[[EQUIPMENT::'+t.id+']]"">'+t.getName(!0)+"</em>"+(a?"<i>+"+a+"</i>":""):"")+"</strong>"},_tmpl.improvement__resource=function(e,t){function a(e){return e=parseInt(e),0>e?"?":e}var n={};n.all='<span><em>必要资源</em><i class="fuel">'+a(e.resource[0][0])+'</i><i class="ammo">'+a(e.resource[0][1])+'</i><i class="steel">'+a(e.resource[0][2])+'</i><i class="bauxite">'+a(e.resource[0][3])+"</i></span>";for(var i=1;4>i;i++){var o="";switch(i){case 1:o="★+0 ~ +6";break;case 2:o="★+6 ~ MAX";break;case 3:o="升级"}n[i]="<span><em>"+o+"</em>"+(3!=i||t?'<i class="dev_mat">'+a(e.resource[i][0])+"<i>("+a(e.resource[i][1])+')</i></i><i class="imp_mat">'+a(e.resource[i][2])+"<i>("+a(e.resource[i][3])+")</i></i>"+(e.resource[i][4]?'<i class="equipment" style="background-image:url(../app/assets/images/itemicon/'+_g.data.items[e.resource[i][4]].getIconId()+'.png)" data-infos="[[EQUIPMENT::'+e.resource[i][4]+']]" data-tip="[[EQUIPMENT::'+e.resource[i][4]+']]">'+_g.data.items[e.resource[i][4]].getName(!0)+"<i>x"+a(e.resource[i][5])+"</i></i>":""):'<i class="no">-</i>')+"</span>"
}return"<span>"+n.all+n[1]+n[2]+n[3]+"</span>"},_tmpl.link_equipment=function(e,t,a,n){if(!e)return!1;if(t&&"object"==typeof t)return _tmpl.link_equipment(e,t.tagName||null,t.returnHTML||null,"undefined"==typeof t.improvementStar?null:t.improvementStar);if(t=t||"button",a=a||!1,n="undefined"==typeof n?null:n,"object"!=typeof e){var i=parseInt(e);e=_g.data.items[i]}else var i=e.id;return _tmpl.export("<"+t+' class="link_equipment" data-equipmentid="'+i+'" data-tip-position="right" data-infos="[[EQUIPMENT::'+i+']]" data-tip="[[EQUIPMENT::'+i+']]"><i style="background-image:url(assets/images/itemicon/'+e.getIconId()+'.png)"></i><small>'+e.getName(!0)+"</small>"+(null!==n?"<em"+(0>=n?' class="zero"':"")+">+"+n+"</em>":"")+"</"+t+">",a)},_tmpl.link_ship=function(e,t,a){if(!e)return!1;if(t&&"object"==typeof t)return _tmpl.link_ship(e,t.tagName||null,t.returnHTML||null);if(t=t||"button",a=a||!1,"object"!=typeof e){var n=parseInt(e);e=_g.data.ships[n]}else var n=e.id;var i=e.getType();return _tmpl.export("<"+t+' class="link_ship" data-shipid="'+n+'" data-infos="[[SHIP::'+n+']]"><img src="'+node.path.normalize(_g.path.pics.ships+"/"+n)+'/0.webp"/><span>'+(i?"<small>"+i+"</small>":"")+e.getName(_g.joint)+"</span></"+t+">",a)},_tmpl.textlink_ship=function(e,t,a){if(!e)return!1;if(t&&"object"==typeof t)return _tmpl.textlink_ship(e,t.tagName||null,t.returnHTML||null);if(t=t||"a",a=a||!1,"object"!=typeof e){var n=parseInt(e);e=_g.data.ships[n]}else var n=e.id;var i=e.getType();return _tmpl.export("<"+t+' href="?infos=ship&id='+n+'" data-shipid="'+n+'" data-infos="[[SHIP::'+n+']]">'+(i?"["+i+"] ":"")+e.getName(_g.joint)+"</"+t+">",a)},_frame.app_main.page.ships={},_frame.app_main.page.ships.init=function(e){this.tablelist=e.find(".tablelist"),this.tablelistObj=this.tablelist.data("tablelist"),e.on("pageon",function(){_frame.app_main.page.ships.tablelistObj||(_frame.app_main.page.ships.tablelistObj=_frame.app_main.page.ships.tablelist.data("tablelist")),_frame.app_main.page.ships.tablelistObj&&_frame.app_main.page.ships.tablelistObj.thead_redraw()})},_frame.app_main.page.equipments={},_frame.app_main.page.equipments.init=function(e){this.tablelist=e.find(".tablelist"),this.tablelistObj=this.tablelist.data("tablelist"),e.on("pageon",function(){_frame.app_main.page.equipments.tablelistObj||(_frame.app_main.page.equipments.tablelistObj=_frame.app_main.page.equipments.tablelist.data("tablelist")),_frame.app_main.page.equipments.tablelistObj&&_frame.app_main.page.equipments.tablelistObj.thead_redraw()})},_frame.app_main.page.equipments.gen_helper_equipable_on=function(e){var t="";for(var a in _g.data.item_types[e].equipable_on_type){var n=_g.data.item_types[e].equipable_on_type[a];t+="<span>"+_g.data.ship_types[n].full_zh+(parseInt(a)<_g.data.item_types[e].equipable_on_type.length-1?",&nbsp;":"")+"</span>"}return'<em class="helper" data-tip="<h4 class=item_equipable_on>可装备于</h4>'+t+'">?</em>'},_frame.app_main.page.arsenal={},_frame.app_main.page.arsenal.init=function(e){$("<input/>",{id:"arsenal_headtab-1",type:"radio",name:"arsenal_headtab"}).prop("checked",!0).appendTo(e),$("<input/>",{id:"arsenal_headtab-2",type:"radio",name:"arsenal_headtab"}).appendTo(e);var t=$("<div/>",{"class":"tabs",html:'<label for="arsenal_headtab-1" class="tab">每日改修</label><label for="arsenal_headtab-2" class="tab">明细表</label>'}).appendTo(e),a=$("<span/>",{animation:Math.floor(3*Math.random()+1)}).on("animationiteration, webkitAnimationIteration",function(){a.attr("animation",Math.floor(3*Math.random()+1))}).appendTo($('<div class="akashi"/>').prependTo(t));$('<div class="main"/>').append(this.init_weekday()).append(this.init_all()).appendTo(e)},_frame.app_main.page.arsenal.init_weekday=function(){var e=$('<div class="body body-1 body-weekday"/>'),t=$('<div class="weekday"/>').appendTo(e),a=$("<div/>").html("<span>星期</span>").appendTo(t),n=[];$("<input/>",{type:"checkbox",id:"arsenal_weekday-showmeterials"}).prop("checked",Lockr.get("arsenal_weekday-showmeterials",!0)?!0:!1).on("change",function(){Lockr.set("arsenal_weekday-showmeterials",$(this).prop("checked")?1:0)}).prependTo(e);for(var i=0;7>i;i++){var o;switch(i){case 0:o="日";break;case 1:o="一";break;case 2:o="二";break;case 3:o="三";break;case 4:o="四";break;case 5:o="五";break;case 6:o="六"}n[i]=$("<input/>",{id:"arsenal_weekday-"+i,type:"radio",name:"arsenal_weekday"}).prependTo(e),$("<label/>",{html:o,"for":"arsenal_weekday-"+i}).appendTo(a),$('<div class="content content-'+i+'"/>').append(_p.el.flexgrid.create().appendDOM(function(){var e=$();for(var t in _g.data.arsenal_weekday[i]){var a=_g.data.arsenal_weekday[i][t];e=e.add(_tmpl.improvement(a[0],a[1],a[2]).addClass("unit"))}return e})).appendTo(e)}$("<span/>",{html:"<b>*</b>日本东京时间"}).appendTo(t),$("<label/>",{"for":"arsenal_weekday-showmeterials",html:"显示资源消耗"}).appendTo(t);var s=new Date;return s.setTime(s.getTime()+60*s.getTimezoneOffset()*1e3),s.setTime(s.getTime()+324e5),n[s.getDay()].prop("checked",!0),e},_frame.app_main.page.arsenal.init_all=function(){var e=$('<div class="body body-2 body-all"/>');for(var t in _g.data.arsenal_all){var a=_g.data.arsenal_all[t];_tmpl.improvement_detail(a).appendTo(e)}return e},_frame.app_main.page.about={},_frame.app_main.page.about.journal_parse=function(e){for(var t,a=/\[\[([^\:]+)\:([0-9]+)\]\]/gi,n=markdown.toHTML(e);null!==(t=a.exec(e));)try{n=n.replace(t[0],_tmpl["link_"+t[1].toLowerCase()](t[2],null,!0))}catch(i){}for(t=null,a=/\[\[([^\:]+)\:([0-9]+)\:TEXT\]\]/gi;null!==(t=a.exec(e));)try{n=n.replace(t[0],_tmpl["textlink_"+t[1].toLowerCase()](t[2],null,!0))}catch(i){}return n},_frame.app_main.page.about.journaltitle=function(e,t){return e=e||{},t=t||"h3","<h3>"+(e.hotfix?"HOTFIX - ":"")+("app"==e.type?"":("app-db"==e.type?"DB":e.type).toUpperCase()+" / ")+e.version+"<small>"+(e.date?e.date:"WIP")+"</small></h3>"},_frame.app_main.page.about.init=function(e){function t(t){var a=$('<section class="update_journal" data-version-'+t.type+'="'+t.version+'"/>').html(_frame.app_main.page.about.journaltitle(t)).appendTo(e);try{$(_frame.app_main.page.about.journal_parse(t.journal)).appendTo(a)}catch(n){_g.error(n),a.remove()}}var a=Q.fcall(function(){});a.then(function(){var e=Q.defer();return _db.updates.find({date:""}).sort({date:-1}).exec(function(a,n){for(var i in n)t(n[i]);e.resolve(a)}),e.promise}).then(function(){var e=Q.defer();return _db.updates.find({$not:{date:""}}).sort({date:-1}).exec(function(a,n){for(var i in n)t(n[i]);e.resolve(a)}),e.promise})},_frame.infos={historyLength:-1,historyCurrent:-1,contentCache:{},getContent:function(e,t){return this.contentCache[e]||(this.contentCache[e]={}),"__NEW__"==t?_p.initDOM(_frame.infos["__"+e](t)):(this.contentCache[e][t]||(this.contentCache[e][t]=_p.initDOM(_frame.infos["__"+e](t))),this.contentCache[e][t])},show:function(e,t,a){var n=/^\[\[([^\:]+)\:\:(.+)\]\]$/.exec(e),i=null,o=null;if(!(n&&n.length>2))return!1;switch(i=n[1].toLowerCase(),o=isNaN(n[2])?n[2]:parseInt(n[2]),i){case"item":case"equip":i="equipment"}return this.curContent==i+"::"+o?_frame.infos.dom.container.children("div:first-child"):(a||(this.historyCurrent++,this.historyLength=this.historyCurrent,_frame.app_main.pushState({infos:i,id:o,infosHistoryIndex:_frame.infos.historyCurrent},null,"?infos="+i+"&id="+o)),void this.show_func(i,o,a))},show_func:function(e,t,a,n){if(!e||!t)return!1;if(this.curContent==e+"::"+t)return _frame.infos.dom.container.children("div:first-child");e=e.toLowerCase(),t=isNaN(t)?t:parseInt(t);var i="";switch(_frame.infos.dom||(_frame.infos.dom={nav:$('<div class="infos"/>').appendTo(_frame.dom.nav),main:$('<div class="page infos"/>').appendTo(_frame.dom.main)},_frame.infos.dom.container=$('<div class="wrapper"/>').appendTo(_frame.infos.dom.main),_frame.infos.dom.back=$('<button class="back" icon="arrow-set2-left"/>').on({click:function(){_frame.infos.dom.forward.removeClass("disabled"),history.back()},"transitionend.infos_hide":function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==parseInt(_frame.infos.dom.back.css("opacity"))&&_frame.infos.hide_finish()}}).appendTo(_frame.infos.dom.nav),_frame.infos.dom.forward=$('<button class="forward disabled" icon="arrow-set2-right"/>').on("click",function(){history.forward()}).appendTo(_frame.infos.dom.nav)),n="undefined"!=typeof n?n:this.historyCurrent,this.historyCurrent=n,this.historyCurrent==this.historyLength&&this.historyCurrent>-1&&_frame.infos.dom.forward.addClass("disabled"),_frame.dom.layout.addClass("infos-show"),e){case"ship":i=this.getContent(e,t),_frame.infos.dom.main.attr("data-infostype","shipinfo");break;case"equipment":i=this.getContent(e,t),_frame.infos.dom.main.attr("data-infostype","equipmentinfo");break;case"fleet":i=this.getContent(e,t),_frame.infos.dom.main.attr("data-infostype","fleetinfo")}var o=i.append?i:$(i);o.on("transitionend.hide",function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==parseInt(o.css("opacity"))&&o.detach()}).prependTo(_frame.infos.dom.container),this.curContent=e+"::"+t,_frame.app_main.cur_page&&(this.lastCurrentPage=_frame.app_main.cur_page,_frame.dom.navs[_frame.app_main.cur_page].removeClass("on"),_frame.app_main.cur_page=null),setTimeout(function(){_frame.dom.layout.addClass("infos-on")},1)},hide:function(){return _frame.infos.dom&&this.curContent?(_frame.dom.layout.removeClass("infos-on"),_frame.infos.dom.forward.addClass("disabled"),this.curContent=null,void(this.lastCurrentPage&&(_frame.dom.navs[this.lastCurrentPage].addClass("on"),_frame.app_main.cur_page=this.lastCurrentPage))):!1},hide_finish:function(){return _frame.infos.curContent?!1:(_frame.dom.layout.removeClass("infos-show"),_frame.infos.dom.main.attr({"data-infostype":"","data-theme":""}),this.historyLength=-1,void(this.historyCurrent=-1))},historyback:function(){_frame.infos.dom.main.children().slice(1).remove(),_frame.infos.dom.main.children().eq(0).removeClass("off").addClass("fadein"),_frame.infos.dom.historyback.empty().removeClass("show"),_frame.infos.dom.main.children().eq(0).hasClass("ship")?_frame.infos.dom.main.attr("data-infostype","shipinfo"):_frame.infos.dom.main.children().eq(0).hasClass("equipment")&&_frame.infos.dom.main.attr("data-infostype","equipmentinfo")}},_frame.infos.init=function(){return _frame.infos.is_init?!0:($body.on("click._infos","[data-infos]",function(e){if("input"!=e.target.tagName.toLowerCase()||"compare"!=e.target.className){var t=$(this);_frame.infos.show(t.attr("data-infos"),t,t.attr("data-infos-nohistory")),"a"==e.target.tagName.toLowerCase()&&e.preventDefault()}}),_frame.infos.is_init=!0,!0)},_frame.infos.__ship=function(e){function t(e,t){return t||0!=e&&"0"!=e?-1==e||"-1"==e?'<small class="zero">?</small>':e:'<small class="zero">-</small>'}function a(e,a,i){function o(e,t,a){return 0>t||0>a?-1:Math.floor(t+(a-t)*e/99)}var s=0,r=null;switch(e){case"hp":s=t(n.stat.hp),r=n.stat.hp>=90?n.stat.hp+9:n.stat.hp>=70?n.stat.hp+8:n.stat.hp>=50?n.stat.hp+7:n.stat.hp>=40?n.stat.hp+6:n.stat.hp>=30?n.stat.hp+5:n.stat.hp+4,r>n.stat.hp_max&&(r=n.stat.hp_max);break;case"asw":s=t(o(99,n.stat.asw,n.stat.asw_max),/^(5|8|9|12|24)$/.test(n.type)),r=t(o(150,n.stat.asw,n.stat.asw_max),/^(5|8|9|12|24)$/.test(n.type));break;case"evasion":case"los":s=t(o(99,n.stat[e],n.stat[e+"_max"])),r=t(o(150,n.stat[e],n.stat[e+"_max"]));break;case"speed":s=_g.getStatSpeed(n.stat.speed);break;case"range":s=_g.getStatRange(n.stat.range);break;case"luck":s=n.stat.luck+"<sup>"+n.stat.luck_max+"</sup>",r=n.stat.luck+3+"<sup>"+n.stat.luck_max+"</sup>";break;case"fuel":case"ammo":s=t(n.consum[e]),r=t(Math.floor(.85*n.consum[e]));break;default:s=t(n.stat[e+"_max"]||n.stat[e])}$("<span/>").html('<small class="stat-'+e+'">'+a+"</small><em"+(r?' class="lvl99"':"")+">"+s+"</em>"+(r?'<em class="lvl150">'+r+"</em>":"")).appendTo(i)}var n=_g.data.ships[e];_g.log(n);var i=$('<div class="ship"/>'),o=n.getName(_g.joint)||"舰娘",s=[],r=n.no&&parseInt(n.no)<500?!0:!1;$('<div class="title"/>').html('<h2 data-content="'+o+'">'+o+'</h2><small><span data-tip="'+(r?"图鉴编号":"无图鉴编号")+'">No.'+(r?n.no:"-")+"</span>"+(n["class"]?_g.data.ship_classes[n["class"]].name_zh+"级":"")+(n.class_no?"<em>"+n.class_no+"</em>号舰":"")+(n.type?" / "+_g.data.ship_types[n.type].full_zh:"")+"</small>").appendTo(i);var p="_input_g"+parseInt(_g.inputIndex),d="_input_g"+(parseInt(_g.inputIndex)+1),l=parseInt(_config.get("ship_infos_lvl")||99),_=$('<div class="stats"/>').html('<div class="title"><h4 data-content="基础属性">基础属性</h4><span><label for="'+p+'" class="lvl99">99</label><label for="'+d+'" class="lvl150">150</label></span></div>').prepend($('<input type="radio" name="ship_infos_lvl_'+e+'" id="'+p+'" value="99"/>').prop("checked",99==l).on("change",function(){_config.set("ship_infos_lvl",$(this).val())})).prepend($('<input type="radio" name="ship_infos_lvl_'+e+'" id="'+d+'" value="150"/>').prop("checked",150==l).on("change",function(){_config.set("ship_infos_lvl",$(this).val())})).appendTo(i),m=$('<div class="stat"/>').appendTo(_),c=$('<div class="stat"/>').appendTo(_),u=$('<div class="stat"/>').appendTo(_),f=$('<div class="stat consum"/>').appendTo(_);_g.inputIndex+=2,a("hp","耐久",m),a("armor","装甲",m),a("evasion","回避",m),a("carry","搭载",m),a("fire","火力",c),a("torpedo","雷装",c),a("aa","对空",c),a("asw","对潜",c),a("speed","航速",u),a("range","射程",u),a("los","索敌",u),a("luck","运",u),a("fuel","油耗",f),a("ammo","弹耗",f);for(var h=$('<div class="equipments"/>').html('<h4 data-content="初始装备 & 搭载量">初始装备 & 搭载量</h4>').appendTo(i),g=0;4>g;){var b=$("<button/>").appendTo(h),v=$("<i/>").appendTo(b),y=$("<small/>").appendTo(b),w=$("<em/>").appendTo(b);if("undefined"==typeof n.slot[g])b.addClass("no");else if("undefined"!=typeof n.equip[g]&&n.equip[g]&&""!==n.equip[g]){var k=_g.data.items[n.equip[g]],T="assets/images/itemicon/"+k.getIconId()+".png";b.attr({"data-equipmentid":n.equip[g],"data-tip-position":"left","data-infos":"[[EQUIPMENT::"+n.equip[g]+"]]","data-tip":"[[EQUIPMENT::"+n.equip[g]+"]]"}),y.html(k.getName(!0)),w.html(n.slot[g]),v.css("background-image","url("+T+")")}else b.addClass("empty"),y.html("--未装备--"),w.html(n.slot[g]);g++}var x=$('<div class="modernization"/>').html('<h4 data-content="合成">合成</h4>').appendTo(h),_=$('<div class="stats"/>').appendTo(x),I=!1;for(var g in n.modernization)if(n.modernization[g]){I=!0;var C;switch(parseInt(g)){case 0:C="fire";break;case 1:C="torpedo";break;case 2:C="aa";break;case 3:C="armor"}$('<span class="stat-'+C+'"/>').html("+"+n.modernization[g]).appendTo(_)}163==n.id&&$('<span class="stat-luck"/>').html("+1.2").appendTo(_),402==n.id&&$('<span class="stat-luck"/>').html("+1.6").appendTo(_),I||x.addClass("no").append($("<em/>").html("-")),$('<span class="entity"/>').html("<strong>声优</strong><span>"+(n.rels.cv?_g.data.entities[n.rels.cv].name[_g.lang]:"?")+"</span>").appendTo(i),$('<span class="entity"/>').html("<strong>画师</strong><span>"+(n.rels.illustrator?_g.data.entities[n.rels.illustrator].name[_g.lang]:"?")+"</span>").appendTo(i);var q=$('<div class="remodels"/>').html('<h4 data-content="改造">改造</h4>').appendTo(i),S=_p.el.flexgrid.create().appendTo(q);n.series&&_db.ship_series.find({id:n.series},function(e,t){function a(e){e=e.replace(/\\/g,"/");try{var t=node.fs.lstatSync(e);t&&t.isFile()&&(u++,$('<input type="radio" name="ship_'+n.id+'_illustrations" value="'+u+'"/>').prop("checked",1==u).insertBefore(j),$('<span class="container"/>').html('<img src="'+e+'" data-filename="'+o+" - "+u+'.webp"/>').appendTo(j))}catch(a){}}if(!e&&t&&t.length){for(var i in t[0].ships){var r=parseInt(i),p=_g.data.ships[t[0].ships[i].id],d=p.getName(_g.joint),l='<h3 class="shipinfo"><strong data-content="'+d+'">'+d+"</strong>"+(p.type?"<small>"+_g.data.ship_types[p.type].full_zh+"</span>":"")+"</h3>",_=r?t[0].ships[r-1].next_lvl:null,m=r?t[0].ships[r-1].next_blueprint:null;if(S.appendDOM($('<button class="unit" data-shipid="'+t[0].ships[i].id+'"/>').attr({"data-infos":"[[SHIP::"+t[0].ships[i].id+"]]","data-tip":l,"data-infos-nohistory":!0}).addClass(t[0].ships[i].id==n.id?"on":"").addClass(m?"blueprint":"").html('<i><img src="'+_g.path.pics.ships+"/"+t[0].ships[i].id+'/0.webp"/></i>'+(_?"<strong>"+_+"</strong>":""))),t[0].ships[i].id==n.id)if(t[0].ships[i].illust_delete){if(r&&(s.push(t[0].ships[r-1].id),t[0].ships[r-1].illust_extra&&t[0].ships[r-1].illust_extra.length&&t[0].ships[r-1].illust_extra[0]))for(var c in t[0].ships[r-1].illust_extra)s.push("extra_"+t[0].ships[r-1].illust_extra[c])}else if(s.push(t[0].ships[i].id),t[0].ships[i].illust_extra&&t[0].ships[i].illust_extra.length&&t[0].ships[i].illust_extra[0])for(var c in t[0].ships[i].illust_extra)s.push("extra_"+t[0].ships[i].illust_extra[c])}var u=0;for(var i in s)a(_g.path.pics.ships+"/"+s[i]+"/8.webp"),a(_g.path.pics.ships+"/"+s[i]+"/9.webp")}});var E=$('<aside class="illustrations"/>').appendTo(i),j=$("<div/>").appendTo(E);return i},_frame.infos.__equipment=function(e){function t(e,t){if(a.stat[e]){var n='<small class="stat-'+e+'">'+t+"</small>";switch(e){case"range":n+="<em>"+_g.getStatRange(a.stat[e])+"</em>";break;default:var i=parseInt(a.stat[e]);n+="<em"+(0>i?' class="negative"':"")+">"+(i>0?"+":"")+i+"</em>"}$("<span/>").html(n).appendTo(o)}}var a=_g.data.items[e];_g.log(a);var n=$('<div class="equipment"/>');$('<div class="title"/>').html('<h2 data-content="'+a.getName()+'">'+a.getName()+'</h2><small><span data-tip="图鉴编号">No.'+a.id+"</span>"+(a.type?a.getType()+_frame.app_main.page.equipments.gen_helper_equipable_on(a.type):"")+"</small>").appendTo(n);var i=$('<div class="stats"/>').html('<h4 data-content="属性">属性</h4>').appendTo(n),o=$('<div class="stat"/>').appendTo(i);t("fire","火力"),t("torpedo","雷装"),t("aa","对空"),t("asw","对潜"),t("bomb","爆装"),t("hit","命中"),t("armor","装甲"),t("evasion","回避"),t("los","索敌"),t("range","射程");var s=$('<div class="stats"/>').html('<h4 data-content="开发改修">开发改修</h4>').appendTo(n),r=$('<div class="stat"/>').appendTo(s);if($("<span/>").append($('<small class="indicator">').addClass(a.craftable?"true":"false").html(a.craftable?"可开发":"不可开发")).appendTo(r),$("<span/>").append($('<small class="indicator">').addClass(a.improvable?"true":"false").html(a.improvable?"可改修":"不可改修")).appendTo(r),!a.improvable||a.upgrade_to&&a.upgrade_to.push&&a.upgrade_to.length||$("<span/>").html('<small class="indicator false">不可升级</small>').appendTo(r),a.upgrade_to&&a.upgrade_to.push&&a.upgrade_to.length){var p=$('<div class="stat upgrade"/>').html('<span><small class="indicator true">可升级为</small></span>').appendTo(s);for(var d in a.upgrade_to)_tmpl.link_equipment(a.upgrade_to[d][0],null,null,a.upgrade_to[d][1]).appendTo(p)}if(a.upgrade_from&&a.upgrade_from.push&&a.upgrade_from.length){var l=$('<div class="stats"/>').html('<h4 data-content="可由以下装备升级获得">可由以下装备升级获得</h4>').appendTo(n),_=$('<div class="stat upgrade"/>').appendTo(l);for(var d in a.upgrade_from)_tmpl.link_equipment(a.upgrade_from[d]).appendTo(_)}var m=$('<div class="equipped"/>').html('<h4 data-content="初始装备于">初始装备于</h4>').appendTo(n),c=_p.el.flexgrid.create().appendTo(m);if(a.default_equipped_on&&a.default_equipped_on.length)for(var d in a.default_equipped_on)c.appendDOM(_tmpl.link_ship(a.default_equipped_on[d]).addClass("unit"));else c.addClass("no").html("暂无初始配置该装备的舰娘...");var u=$('<aside class="illustrations"/>').appendTo(n);try{var f=_g.path.pics.items+"/"+a.id+"/card.webp",h=node.fs.lstatSync(f);h&&h.isFile()&&$('<img src="'+f+'" data-filename="'+a.getName()+'.webp"/>').appendTo(u)}catch(g){}return n},_frame.infos.__fleet=function(e){return new fleetInfos(e).dom};var fleetInfos=function(e){var t=this;this.dom=$('<div class="fleet loading"/>'),this.doms={},"__NEW__"==e?_db.fleets.insert(_tablelist.prototype._fleets_new_data(),function(e,a){e?_g.error(e):"fleet::__NEW__"==_frame.infos.curContent&&t.init(a)}):_db.fleets.find({_id:e},function(a,n){a||!n?_g.error(a):_frame.infos.curContent=="fleet::"+e&&t.init(n[i])})};fleetInfos.prototype.init=function(e){if(!e)return!1;_g.log(e);var t=this,a=0;for(this.dom.attr("data-fleetid",e._id).data("fleet",e).removeClass("loading"),$("<header/>").append(t.doms.name=$("<h3 contenteditable/>").html("点击编辑标题").on({input:function(){t.update_data({}),t.doms.name.trigger("namechange")},focus:function(){"点击编辑标题"==t.doms.name.text()&&t.doms.name.html("")},blur:function(){t.doms.name.text()||t.doms.name.html("点击编辑标题")},namechange:function(e,a){return"undefined"==typeof a?a=t.doms.name.text():t.doms.name.html(a),a?t.doms.name.attr("data-content",a):t.doms.name.removeAttr("data-content"),t.doms.name}})).append(t.doms.user=$("<button/>")).appendTo(t.dom),$('<div class="fleets"/>').append(t.doms.tabs=$('<div class="tabs"/>')).append(t.doms.options=$('<div class="options"/>').append($("<span/>").html("[PH] 阵型")).append($("<span/>").html("[PH] 颜色")).append($("<span/>").html("[PH] 分享"))).appendTo(t.dom),this.doms.ships=$('<div class="ships"/>').appendTo(t.dom);4>a;){a++,$("<input/>",{type:"radio",name:"fleet_"+e._id+"_tab",id:"fleet_"+e._id+"_tab_"+a,value:a}).prop("checked",1==a).prependTo(t.dom),$("<label/>",{"for":"fleet_"+e._id+"_tab_"+a,"data-fleet":a,html:"#"+a}).appendTo(t.doms.tabs),t.doms["fleet"+a]=$("<dl/>",{"data-fleet":a}).appendTo(t.doms.ships);for(var n=0;6>n;)n++,t.doms["ship"+a+"-"+n]=$("<dd/>").html("ship"+a+"-"+n).appendTo(t.doms["fleet"+a])}this.update(e)},fleetInfos.prototype.fleettab_add=function(){},fleetInfos.prototype.update=function(e){e=e||{};var t=this;if("undefined"!=typeof e.theme&&_frame.infos.dom.main.attr("data-theme",e.theme),"undefined"!=typeof e.name&&this.doms.name.trigger("namechange",[e.name]).trigger("blur"),e.data&&e.data.push)if(e.data.length)for(var a in e.data)t.fleettab_add();else t.fleettab_add()},fleetInfos.prototype.update_data=function(e){e=e||{},this.update(e)},"undefined"!=typeof _p.tip&&(_p.tip.filters.push(function(e){var t=/^\[\[EQUIPMENT\:\:([0-9]+)\]\]$/.exec(e);return t&&t.length>1?_p.tip.content_equipment(_g.data.items[parseInt(t[1])]):void 0}),_p.tip.content_equipment=function(e){function t(t,a){if(!e.stat[t])return"";switch(t){case"range":return"<span>射程: "+_g.getStatRange(e.stat[t])+"</span>";default:var n=parseInt(e.stat[t]);return"<span>"+(n>0?"+":"")+n+" "+a+"</span>"}}var a="assets/images/itemicon/"+e.getIconId()+".png",n=e.getName(),i='<h3 class="itemstat"><s style="background-image: url('+a+')"></s><strong data-content="'+n+'">'+n+"</strong><small>"+_g.data.item_types[e.type].name.zh_cn+"</small></h3>"+t("fire","火力")+t("torpedo","雷装")+t("aa","对空")+t("asw","对潜")+t("bomb","爆装")+t("hit","命中")+t("armor","装甲")+t("evasion","回避")+t("los","索敌")+t("range","射程");return i}),"undefined"!=typeof _p.tip&&(_p.tip.filters.push(function(e){var t=/^\[\[SHIP\:\:([0-9]+)\]\]$/.exec(e);return t&&t.length>1?_p.tip.content_ship(_g.data.ships[parseInt(t[1])]):void 0}),_p.tip.content_ship=function(e){var t=e.getName(_g.joint),a='<h3 class="shipinfo"><img src="'+_g.path.pics.ships+"/"+e.id+'/0.webp"/><strong data-content="'+t+'">'+t+"</strong>"+(e.type?"<small>"+_g.data.ship_types[e.type].full_zh+"</span>":"")+"</h3>";return a}),_p.el.tablelist={init_el:function(e){return e.data("tablelist")?!0:void e.data({tablelist:new _tablelist(e)})},init:function(e,t){e=e||$body,t=t||e.find(".tablelist"),t.each(function(){_p.el.tablelist.init_el($(this))})}};var _tablelist=function(e){this.dom={container:e},e.hasClass("ships")?this.listtype="ships":e.hasClass("equipments")?this.listtype="equipments":e.hasClass("fleets")&&(this.listtype="fleets"),this._index=this.global_index,this.global_index++,this.init()};_tablelist.prototype.global_index=0,_tablelist.prototype.flexgrid_empty_count=6,_tablelist.prototype.sort_data_by_stat={},_tablelist.prototype.sort_default_order_by_stat={},_tablelist.prototype._ships_columns=["  ",["火力","fire"],["雷装","torpedo"],["夜战","nightpower"],["对空","aa"],["对潜","asw"],["耐久","hp"],["装甲","armor"],["回避","evasion"],["搭载","carry"],["航速","speed"],["射程","range"],["索敌","los"],["运","luck"],["油耗","consum_fuel"],["弹耗","consum_ammo"]],_tablelist.prototype._ships_header_checkbox=[],_tablelist.prototype._ships_last_item=null,_tablelist.prototype._ships_append_item=function(e,t){function a(e,t){return t||0!=e&&"0"!=e?-1==e||"-1"==e?'<small class="zero">?</small>':e:'<small class="zero">-</small>'}var n=this,i=_g.data.ship_types[e.type].donotcompare?!0:!1,o=$('<tr class="row" data-shipid="'+e.id+'" data-header="'+t+'" data-trindex="'+n.trIndex+'"/>').attr({"data-infos":"[[SHIP::"+e.id+"]]","data-shipedit":n.dom.container.hasClass("shiplist-edit")?"true":null,"data-donotcompare":i?!0:null}).insertAfter(n._ships_last_item),s=0,r=e.name[_g.lang]+(e.name.suffix?"<small>"+_g.data.ship_namesuffix[e.name.suffix][_g.lang]+"</small>":""),p=$('<input type="checkbox" class="compare"/>').prop("disabled",i).on("click, change",function(e,a){$(this).prop("checked")?o.attr("compare-checked",!0):o.removeAttr("compare-checked"),n._ships_compare_btn_show($(this).prop("checked")),a||n._ships_header_checkbox[t].trigger("docheck")});n._ships_last_item=o,n.trIndex++,n._ships_header_checkbox[t].data("ships",n._ships_header_checkbox[t].data("ships").add(o)),o.data("checkbox",p);for(var d in e.carry)s+=e.carry[d];for(var d in n._ships_columns)switch(n._ships_columns[d][1]){case" ":$("<th/>").html('<img src="'+_g.path.pics.ships+"/"+e.id+'/0.webp" contextmenu="disabled"/><strong>'+r+"</strong>").prepend(p).appendTo(o);break;case"nightpower":var l=/^(9|10|11)$/.test(e.type)?0:parseInt(e.stat.fire_max||0)+parseInt(e.stat.torpedo_max||0);$('<td data-stat="nightpower"/>').attr("data-value",-1==l||"-1"==l?null:l).html(a(l)).appendTo(o);break;case"asw":$('<td data-stat="asw" />').attr("data-value",-1==e.stat.asw_max||"-1"==e.stat.asw_max?null:e.stat.asw_max).html(a(e.stat.asw_max,/^(5|8|9|12|24)$/.test(e.type))).appendTo(o);break;case"hp":$('<td data-stat="hp" data-value="'+e.stat.hp+'"/>').html(a(e.stat.hp)).appendTo(o);break;case"carry":$('<td data-stat="carry" data-value="'+e.stat.carry+'"/>').html(a(e.stat.carry)).appendTo(o);break;case"speed":$('<td data-stat="speed" data-value="'+e.stat.speed+'"/>').html(_g.getStatSpeed(e.stat.speed)).appendTo(o);break;case"range":$('<td data-stat="range" data-value="'+e.stat.range+'"/>').html(_g.getStatRange(e.stat.range)).appendTo(o);break;case"luck":$('<td data-stat="luck" data-value="'+e.stat.luck+'"/>').html(e.stat.luck+"<sup>"+e.stat.luck_max+"</sup>").appendTo(o);break;case"consum_fuel":$('<td data-stat="consum_fuel"/>').attr("data-value",-1==e.consum.fuel||"-1"==e.consum.fuel?null:e.consum.fuel).html(a(e.consum.fuel)).appendTo(o);break;case"consum_ammo":$('<td data-stat="consum_ammo"/>').attr("data-value",-1==e.consum.ammo||"-1"==e.consum.ammo?null:e.consum.ammo).html(a(e.consum.ammo)).appendTo(o);break;default:var l=e.stat[n._ships_columns[d][1]+"_max"];$('<td data-stat="'+n._ships_columns[d][1]+'"/>').attr("data-value",-1==l||"-1"==l?-1:l).html(a(l)).appendTo(o)}return e.remodel_next&&_g.data.ships[e.remodel_next]&&_g.ship_type_order_map[e.type]==_g.ship_type_order_map[_g.data.ships[e.remodel_next].type]&&e.name.ja_jp==_g.data.ships[e.remodel_next].name.ja_jp&&o.addClass("premodeled"),o},_tablelist.prototype._ships_append_all_items=function(){function e(a,n){if(_g.data.ship_id_by_type[a]){if(!n){if("object"==typeof _g.ship_type_order[a])var i=_g.data.ship_types[_g.ship_type_order[a][0]];else var i=_g.data.ship_types[_g.ship_type_order[a]];var o="_input_g"+parseInt(_g.inputIndex);t._ships_last_item=$('<tr class="typetitle" data-trindex="'+t.trIndex+'"><th colspan="'+(t._ships_columns.length+1)+'"><label for="'+o+'">'+_g.data.ship_type_order[a].name.zh_cn+(_g.data.ship_type_order[a].name.zh_cn==i.full_zh?"<small>["+i.code+"]</small>":"")+"</label></th></tr>").appendTo(t.dom.tbody),t.trIndex++;for(var s=0;s<t.flexgrid_empty_count;){var r=t.trIndex+_g.data.ship_id_by_type[a].length+s;$('<tr class="empty" data-trindex="'+r+'"/>').appendTo(t.dom.tbody),s++}t._ships_header_checkbox[a]=$('<input type="checkbox" id="'+o+'"/>').prop("disabled",_g.data.ship_type_order[a].donotcompare?!0:!1).on({change:function(){var e=$(this);e.data("ships").filter(":visible").each(function(){$(this).data("checkbox").prop("checked",e.prop("checked")).trigger("change",[!0])})},docheck:function(){var e=$(this).data("ships").filter(":visible"),t=e.filter("[compare-checked=true]");$(this).prop(t.length?t.length<e.length?{checked:!1,indeterminate:!0}:{checked:!0,indeterminate:!1}:{checked:!1,indeterminate:!1})}}).data("ships",$()).prependTo(t._ships_last_item.find("th")),_g.inputIndex++}t._ships_append_item(_g.data.ships[_g.data.ship_id_by_type[a][n]],a),setTimeout(function(){n>=_g.data.ship_id_by_type[a].length-1?(t.trIndex+=t.flexgrid_empty_count,e(a+1,0)):e(a,n+1)},0)}else t.mark_high(),t.thead_redraw(),_frame.app_main.loaded("tablelist_"+t._index,!0),delete t._ships_last_item}var t=this;e(0,0)},_tablelist.prototype._ships_compare_btn_show=function(e){!e&&this.dom.tbody.find('input[type="checkbox"].compare:checked').length||e?this.dom.msg_container.attr("data-msgs","comparestart"):this.dom.msg_container.removeAttr("data-msgs")},_tablelist.prototype._ships_compare_start=function(){this.dom.msg_container.removeAttr("data-msgs"),this._ships_last_viewtype=this.dom.filter_container.attr("viewtype"),_config.set("shiplist-viewtype",this._ships_last_viewtype),this._ships_last_scrollTop=this.dom.table_container_inner.scrollTop(),this.dom.filter_container.attr("viewtype","compare"),this.dom.table_container_inner.scrollTop(0),this.dom.table.addClass("sortable"),this.mark_high(!0),this.thead_redraw(500)},_tablelist.prototype._ships_compare_off=function(){this.dom.filter_container.attr("viewtype",this._ships_last_viewtype),this.sort_table_restore(),this.mark_high(),this.thead_redraw(500),this.dom.table_container_inner.scrollTop(this._ships_last_scrollTop),this.dom.table.removeClass("sortable"),delete this._ships_last_viewtype,delete this._ships_last_scrollTop},_tablelist.prototype._ships_compare_end=function(){this.dom.tbody.find('input[type="checkbox"].compare:checked').prop("checked",!1).trigger("change"),this.dom.msg_container.removeAttr("data-msgs"),this._ships_compare_off()},_tablelist.prototype._ships_compare_continue=function(){this.dom.msg_container.attr("data-msgs","comparestart"),this._ships_compare_off()},_tablelist.prototype._ships_init=function(){function e(e){t.dom.thead=$("<thead/>");var a=$("<tr/>").appendTo(t.dom.thead);for(var n in e)!function(e){if("object"==typeof e)var n=$('<td data-stat="'+e[1]+'"/>').html('<div class="th-inner-wrapper"><span><span>'+e[0]+"</span></span></div>").on("click",function(){t.sort_table_from_theadcell(n)}).appendTo(a);else $("<th/>").html('<div class="th-inner-wrapper"><span><span>'+e[0]+"</span></span></div>").appendTo(a)}(e[n]);return t.dom.thead}var t=this;this.trIndex=0,_frame.app_main.loading.push("tablelist_"+this._index),_frame.app_main.is_loaded=!1,this.dom.filter_container=$('<div class="options"/>').appendTo(this.dom.container),this.dom.filters=$('<div class="filters"/>').appendTo(this.dom.filter_container),this.dom.exit_compare=$('<div class="exit_compare"/>').append($('<button icon="arrow-set2-left"/>').html("结束对比").on("click",function(){t._ships_compare_end()})).append($('<button icon="checkbox-checked"/>').html("继续选择").on("click",function(){t._ships_compare_continue()})).appendTo(this.dom.filter_container),this.dom.btn_compare_sort=$('<button icon="sort-amount-desc" class="disabled"/>').html("点击表格标题可排序").on("click",function(){t.dom.btn_compare_sort.hasClass("disabled")||t.sort_table_restore()}).appendTo(this.dom.exit_compare),this.append_option("checkbox","hide-premodel","仅显示同种同名舰最终版本","false"===_config.get("shiplist-filter-hide-premodel")?null:!0,null,{onchange:function(e,a){_config.set("shiplist-filter-hide-premodel",a.prop("checked")),t.dom.filter_container.attr("filter-hide-premodel",a.prop("checked")),t.thead_redraw()}}),this.append_option("radio","viewtype",null,[["card",""],["list",""]],null,{radio_default:_config.get("shiplist-viewtype"),onchange:function(e,a){a.is(":checked")&&(_config.set("shiplist-viewtype",a.val()),t.dom.filter_container.attr("viewtype",a.val()),t.thead_redraw())
}}),this.dom.filters.find("input").trigger("change"),this.dom.table_container=$('<div class="fixed-table-container"/>').appendTo(this.dom.container),this.dom.table_container_inner=$('<div class="fixed-table-container-inner"/>').appendTo(this.dom.table_container),this.dom.table=$('<table class="ships hashover hashover-column"/>').appendTo(this.dom.table_container_inner),e(t._ships_columns).appendTo(this.dom.table),this.dom.tbody=$("<tbody/>").appendTo(this.dom.table),_g.data.ship_types?t._ships_append_all_items():$("<p/>").html("暂无数据...").appendTo(t.dom.table_container_inner),this.dom.msg_container=$('<div class="msgs"/>').appendTo(this.dom.container),_config.get("hide-compareinfos")||this.dom.msg_container.attr("data-msgs","compareinfos");var a=$('<div class="compareinfos"/>').html("点击舰娘查询详细信息，勾选舰娘进行对比").appendTo(this.dom.msg_container);$("<button/>").html("&times;").on("click",function(){t.dom.msg_container.removeAttr("data-msgs"),_config.set("hide-compareinfos",!0)}).appendTo(a);$('<div class="comparestart"/>').html("开始对比").on("click",function(){t._ships_compare_start()}).appendTo(this.dom.msg_container)},_tablelist.prototype._equipments_columns=["  ",["火力","fire"],["雷装","torpedo"],["对空","aa"],["对潜","asw"],["爆装","bomb"],["命中","hit"],["装甲","armor"],["回避","evasion"],["索敌","los"],["射程","range"]],_tablelist.prototype._equipments_append_item=function(e,t){function a(e,t){return t||0!=e&&"0"!==e&&""!==e?e:'<small class="zero">-</small>'}var n=this,i=$('<tr class="row" data-equipmentid="'+e.id+'" data-equipmentcollection="'+t+'"/>').attr({"data-infos":"[[EQUIPMENT::"+e.id+"]]","data-equipmentedit":n.dom.container.hasClass("equipmentlist-edit")?"true":null}).appendTo(this.dom.tbody);for(var o in n._equipments_columns)switch(n._equipments_columns[o][1]){case" ":$("<th/>").html(e.getName()).appendTo(i);break;case"range":$('<td data-stat="range" data-value="'+e.stat.range+'"/>').html(e.stat.range?_g.getStatRange(e.stat.range):'<small class="zero">-</small>').appendTo(i);break;default:$('<td data-stat="'+n._equipments_columns[o][1]+'" data-value="'+e.stat[n._equipments_columns[o][1]]+'"/>').addClass(e.stat[n._equipments_columns[o][1]]<0?"negative":"").html(a(e.stat[n._equipments_columns[o][1]])).appendTo(i)}return i},_tablelist.prototype._equipments_append_all_items=function(){function e(a,n){if(_g.data.item_id_by_type[a]){if(!n){var i=_g.data.item_types[_g.item_type_order[a]];$('<tr class="typetitle" data-equipmentcollection="'+_g.data.item_id_by_type[a].collection+'"><th colspan="'+(t._equipments_columns.length+1)+'"><span style="background-image: url(../app/assets/images/itemicon/'+i.icon+'.png)"></span>'+i.name.zh_cn+_frame.app_main.page.equipments.gen_helper_equipable_on(i.id)+"</th></tr>").appendTo(t.dom.tbody)}t._equipments_append_item(_g.data.items[_g.data.item_id_by_type[a].equipments[n]],_g.data.item_id_by_type[a].collection),setTimeout(function(){n>=_g.data.item_id_by_type[a].equipments.length-1?e(a+1,0):e(a,n+1)},0)}else t.thead_redraw(),_frame.app_main.loaded("tablelist_"+t._index,!0)}var t=this;e(0,0)},_tablelist.prototype._equipments_init=function(){function e(e){t.dom.thead=$("<thead/>");var a=$("<tr/>").appendTo(t.dom.thead);for(var n in e)"object"==typeof e[n]?$('<td data-stat="'+e[n][1]+'"/>').html('<div class="th-inner-wrapper"><span><span>'+e[n][0]+"</span></span></div>").appendTo(a):$("<th/>").html('<div class="th-inner-wrapper"><span><span>'+e[n][0]+"</span></span></div>").appendTo(a);return t.dom.thead}var t=this;_frame.app_main.loading.push("tablelist_"+this._index),_frame.app_main.is_loaded=!1,this.dom.filter_container=$('<div class="options"/>').appendTo(this.dom.container),this.dom.filters=$('<div class="filters"/>').appendTo(this.dom.filter_container);var a=!1;for(var n in _g.data.item_type_collections){var i="_input_g"+parseInt(_g.inputIndex);$('<input type="radio" name="equipmentcollection" id="'+i+'" value="'+n+'"/>').prop("checked",!a).on("change",function(){t.thead_redraw()}).prependTo(this.dom.container),$('<label class="tab container" for="'+i+'" data-equipmentcollection="'+n+'"/>').html("<i></i><span>"+_g.data.item_type_collections[n].name.zh_cn.replace(/\&/g,"<br/>")+"</span>").appendTo(t.dom.filters),a=!0,_g.inputIndex++}this.dom.table_container=$('<div class="fixed-table-container"/>').appendTo(this.dom.container),this.dom.table_container_inner=$('<div class="fixed-table-container-inner"/>').appendTo(this.dom.table_container),this.dom.table=$('<table class="equipments hashover hashover-column"/>').appendTo(this.dom.table_container_inner),e(t._equipments_columns).appendTo(this.dom.table),this.dom.tbody=$("<tbody/>").appendTo(this.dom.table),t._equipments_append_all_items(),this.dom.msg_container=$('<div class="msgs"/>').appendTo(this.dom.container),_config.get("hide-equipmentsinfos")||this.dom.msg_container.attr("data-msgs","equipmentsinfos");var o=$('<div class="equipmentsinfos"/>').html("点击装备查询初装舰娘等信息").appendTo(this.dom.msg_container);$("<button/>").html("&times;").on("click",function(){t.dom.msg_container.removeAttr("data-msgs"),_config.set("hide-equipmentsinfos",!0)}).appendTo(o)},_tablelist.prototype.append_option=function(e,t,a,n,i,o){function s(){switch(e){case"text":case"number":case"hidden":var a=$('<input type="'+e+'" name="'+t+'" id="'+p+'" />').val(n);break;case"select":var a=$('<select name="'+t+'" id="'+p+'" />'),i=$('<option value=""/>').html("").appendTo(a);for(var s in n){if("object"==typeof n[s])var r=$('<option value="'+("undefined"==typeof n[s].val?n[s].value:n[s].val)+'"/>').html(n[s].title||n[s].name).appendTo(a);else var r=$('<option value="'+n[s]+'"/>').html(n[s]).appendTo(a);"undefined"!=typeof o["default"]&&r.val()==o["default"]&&r.prop("selected",!0)}n&&n.length||(i.remove(),$('<option value=""/>').html("...").appendTo(a)),o["new"]&&($('<option value=""/>').html("==========").insertAfter(i),$('<option value="___new___"/>').html("+ 新建").insertAfter(i),a.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),o["new"](a))}));break;case"checkbox":var a=$('<input type="'+e+'" name="'+t+'" id="'+p+'" />').prop("checked",n);break;case"radio":var a=$();for(var s in n){var d,l,_=!1;n[s].push?(l=n[s][0],d=n[s][1]):(l=n[s].val||n[s].value,d=n[s].title||n[s].name),o.radio_default&&o.radio_default==l&&(_=!0),a=a.add($('<input type="radio" name="'+t+'" id="'+p+"-"+l+'" ischecked="'+_+'" />').val(l).prop("checked",_||!_&&0==s)),a=a.add($('<label for="'+p+"-"+l+'"/>').html(d))}}return o.required&&a.prop("required",!0),o.onchange&&(a.on("change.___onchange___",function(e){o.onchange(e,$(this))}),o["default"]&&a.trigger("change")),t||a.attr("name",null),a}o=o||{};var r=$("<p/>").addClass(t).appendTo(this.dom.filters),p="_input_g"+parseInt(_g.inputIndex),a=a?$('<label for="'+p+'"/>').html(a).appendTo(r):null,d=s().appendTo(r);return"checkbox"==e&&a&&a.insertAfter(d),i&&$('<label for="'+p+'"/>').html(i).appendTo(r),_g.inputIndex++,r},_tablelist.prototype.thead_redraw=function(e){if(this.dom.thead&&this.dom.thead.length){var t=this.dom.thead;setTimeout(function(){t.hide().show(0)},e||10)}},_tablelist.prototype.sort_column=function(e,t,a){if(!a){var n=this.dom.tbody;n&&n.length||(n=this.dom.table.find("tbody")),a=n.find("tr.row:visible").not("[data-donotcompare]")}e=e||1,this._tmp_values=[],this._tmp_value_map_cell={};var i=this;a.find("td:nth-of-type("+e+")").each(function(){var e=$(this),t=$(this).data("value");t=parseFloat(t),$.inArray(t,i._tmp_values)<0&&i._tmp_values.push(t),i._tmp_value_map_cell[t]||(i._tmp_value_map_cell[t]=$()),i._tmp_value_map_cell[t]=i._tmp_value_map_cell[t].add(e)}),this._tmp_values.sort(function(e,a){return t?e-a:a-e});var o=[];for(var s in this._tmp_values)o.push(this._tmp_value_map_cell[this._tmp_values[s]]);return delete this._tmp_values,delete this._tmp_value_map_cell,o},_tablelist.prototype.mark_high=function(e){var t=this.dom.tbody;t&&t.length||(t=this.dom.table.find("tbody"));var a=t.find("tr.row:visible").not("[data-donotcompare]"),n=this,i=this.sort_data_by_stat;return a.find("td[data-value]").removeClass("sort-first sort-second"),a.eq(0).find("td[data-value]").each(function(t){var o=!1,s=$(this),r=s.data("stat"),p=r.match(/\b(speed|range)\b/);"undefined"==typeof n.sort_default_order_by_stat[r]?(r.match(/\b(consum_fuel|consum_ammo)\b/)&&(o=!0),n.sort_default_order_by_stat[r]=o?"asc":"desc"):o="asc"==n.sort_default_order_by_stat[r]?!0:!1;var d=_tablelist.prototype.sort_column(t+1,o,a),l=Math.min(6,Math.ceil(a.length/2)+1);!p&&d.length>1&&d[0].length<l&&(d[0].addClass("sort-first"),d.length>2&&d[1].length<l&&d[1].addClass("sort-second")),e?i[r]=d:delete i[r]}),a},_tablelist.prototype.sort_table_from_theadcell=function(e){var t=e.data("stat"),a=this.sort_data_by_stat[t];if(!t||!a)return!1;t!=this.lastSortedStat&&(this.lastSortedHeader&&this.lastSortedHeader.removeClass("sorting desc asc"),e.addClass("sorting"));var n=t==this.lastSortedStat&&"obverse"==this.lastSortedOrder?"reverse":"obverse",i="reverse"==n?a.length-1:0;if(this.sort_default_order_by_stat[t]){var o="asc"==this.sort_default_order_by_stat[t]?"desc":"asc";"obverse"==n?e.removeClass(o).addClass(this.sort_default_order_by_stat[t]):e.removeClass(this.sort_default_order_by_stat[t]).addClass(o)}for(this.sortedRow=$();a[i];)this._tmpDOM=a[i].parent(),this.sortedRow=this.sortedRow.add(this._tmpDOM),this._tmpDOM.appendTo(this.dom.tbody),i="reverse"==n?i-1:i+1;this.dom.btn_compare_sort.removeClass("disabled").html("取消排序"),this.lastSortedStat=t,this.lastSortedOrder=n,this.lastSortedHeader=e,delete this._tmpDOM},_tablelist.prototype.sort_table_restore=function(){if(!this.sortedRow)return!0;var e,t=[];this.sortedRow.each(function(){var a=$(this),n=parseInt(a.data("trindex"));e=e||a.parent(),t.push({index:n,el:a,prev:e.children('tr[data-trindex="'+(n-1)+'"]')})}),t.sort(function(e,t){return e.index-t.index});for(var a in t)t[a].el.insertAfter(t[a].prev);return this.dom.btn_compare_sort.addClass("disabled").html("点击表格标题可排序"),this.lastSortedHeader.removeClass("sorting desc asc"),delete this.sortedRow,delete this.lastSortedStat,delete this.lastSortedOrder,delete this.lastSortedHeader,!0},_tablelist.prototype.init=function(){return this.is_init?!0:(this["_"+this.listtype+"_init"]&&this["_"+this.listtype+"_init"](),void(this.is_init=!0))},_tablelist.prototype._fleets_columns=["  ",["创建者","user"],["修改时间","time_modify"],["评价","rating"],["","options"]],_tablelist.prototype.kancolle_calc={_ApplicationId:"l1aps8iaIfcq2ZzhOHJWNUU2XrNySIzRahodijXW",_ClientVersion:"js1.2.19",_InstallationId:"62522018-ec82-b434-f5a5-08c3ab61d932",_JavaScriptKey:"xOrFpWEQZFxUDK2fN1DwbKoj3zTKAEkgJHzwTuZ4"},_tablelist.prototype._fleets_new_data=function(e){return $.extend({data:[],time_create:(new Date).valueOf(),time_modify:(new Date).valueOf(),hq_lv:-1,name:"",note:"",user:{},rating:-1,theme:1},e||{})},_tablelist.prototype._fleets_loaddata=function(){return[]},_tablelist.prototype._fleets_datacheck=function(e){return e=e||[],e.length||this.dom.container.addClass("nocontent"),e},_tablelist.prototype._fleets_append_all_items=function(e){e=e||[],e.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0}),_g.log(e);for(var t=this,a=Q.defer(),n=0;n<t.flexgrid_empty_count;)n?$('<tr class="empty" data-fleetid="-1" data-trindex="99999"/>').appendTo(t.dom.tbody):t.flexgrid_ph=$('<tr class="empty" data-fleetid="-1" data-trindex="99999"/>').appendTo(t.dom.tbody),n++;for(var i in e)setTimeout(function(n){t._fleets_append_item(e[n]),n>=e.length-1&&a.resolve()}(i),0);return e.length||a.resolve(),a.promise},_tablelist.prototype._fleets_append_item=function(e,t){if(!e)return!1;"undefined"==typeof t&&(t=this.trIndex,this.trIndex++);var a=this,n=$('<tr class="row"/>').attr({"data-trindex":t,"data-fleetid":"PLACEHOLDER","data-infos":"[[FLEET::"+e._id+"]]"}).insertBefore(this.flexgrid_ph);for(var i in a._fleets_columns)switch(a._fleets_columns[i][1]){case" ":for(var o="<i>",s=e.data[0]||[],r=0;6>r;)o+=s[r]?'<img src="'+_g.path.pics.ships+"/"+s[r][0]+'/0.webp" contextmenu="disabled"/>':"<s/>",r++;o+="</i>",$("<th/>").attr("data-value",e.name).html(o+"<strong>"+e.name+"</strong>").appendTo(n);break;default:var p=e[a._fleets_columns[i][1]];$("<td/>").attr("data-value",p).html(p).appendTo(n)}return n},_tablelist.prototype._fleets_btn_new=function(){var e=this;this._fleets_menu_new||(this._fleets_menu_new=new _menu({target:e.dom.btn_new,items:[$('<div class="menu_fleets_new"/>').append($("<menuitem/>").html("新建配置").on("click",function(){e._fleets_action_new()})).append($("<menuitem/>").html("导入配置代码")).append($("<menuitem/>").html("导入配置文件"))]})),this._fleets_menu_new.show()},_tablelist.prototype._fleets_btn_settings=function(){_g.log("CLICK: 选项设置")},_tablelist.prototype._fleets_action_new=function(){_frame.infos.show("[[FLEET::__NEW__]]"),this._fleets_menu_new.hide()},_tablelist.prototype._fleets_parse_kancolle_calc_data=function(e){return this._fleets_new_data(e)},_tablelist.prototype._fleets_init=function(){function e(e){t.dom.thead=$("<thead/>");var a=$("<tr/>").appendTo(t.dom.thead);for(var n in e)"object"==typeof e[n]?$('<td data-stat="'+e[n][1]+'"/>').html('<div class="th-inner-wrapper"><span><span>'+e[n][0]+"</span></span></div>").appendTo(a):$("<th/>").html('<div class="th-inner-wrapper"><span><span>'+e[n][0]+"</span></span></div>").appendTo(a);return t.dom.thead}var t=this,a=Q.fcall(function(){});_frame.app_main.loading.push("tablelist_"+this._index),_frame.app_main.is_loaded=!1,this.dom.filter_container=$('<div class="options" viewtype="card"/>').appendTo(this.dom.container),this.dom.filters=$('<div class="filters"/>').appendTo(this.dom.filter_container),this.dom.btn_new=$('<button class="new" icon="import"/>').html("新建/导入").on("click",function(){t._fleets_btn_new()}).appendTo(t.dom.filters),this.dom.buttons_right=$('<div class="buttons_right"/>').appendTo(t.dom.filters),this.dom.btn_settings=$('<button icon="cog"/>').on("click",function(){t._fleets_btn_settings()}).appendTo(t.dom.buttons_right),this.dom.table_container=$('<div class="fixed-table-container"/>').appendTo(this.dom.container),this.dom.table_container_inner=$('<div class="fixed-table-container-inner"/>').appendTo(this.dom.table_container),this.dom.table=$('<table class="fleets hashover hashover-column"/>').appendTo(this.dom.table_container_inner),e(t._fleets_columns).appendTo(this.dom.table),this.dom.tbody=$("<tbody/>").appendTo(this.dom.table),$('<div class="nocontent container"/>').append($($("<div/>").append($("<span>").html("暂无舰队配置")).append($("<button>").html("新建/导入").on("click",function(){t.dom.btn_new.click()})))).appendTo(this.dom.table_container_inner),a.then(function(){return t._fleets_loaddata()}).then(function(e){return t._fleets_datacheck(e)}).then(function(e){return t._fleets_append_all_items(e)}).then(function(){setTimeout(function(){_frame.app_main.loaded("tablelist_"+t._index,!0)},100)}).catch(function(e){_g.log(e)}).done(function(){_g.log("Fleets list DONE")})};