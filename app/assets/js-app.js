node.require("fs"),node.require("nedb"),node.require("mkdirp"),node.require("request"),node.require("request-progress"),node.require("semver"),node.require("url");var Q=node.require("q"),markdown=node.require("markdown").markdown;_g.animate_duration_delay=320,_g.inputIndex=0,_g.lang="zh_cn",_g.path={db:node.path.join(_g.root,"/app-db/"),page:node.path.join(_g.root,"/app/page/"),bgimg_dir:node.path.join(_g.root,"/app/assets/images/homebg/"),pics:{ships:node.path.join(_g.root,"/pics/ships/"),items:node.path.join(_g.root,"/pics/items/")}},_g.pathMakeObj=function(e){for(var a in e)"object"==typeof e[a]?_g.pathMakeObj(e[a]):node.mkdirp.sync(e[a])},_g.pathMakeObj(_g.path),_g.data={entities:{},items:{},item_types:{},ships:{},ship_id_by_type:[],ship_types:{},ship_type_order:{},ship_classes:{}};var _db={entities:new node.nedb({filename:_g.path.db+"/entities.json"}),items:new node.nedb({filename:_g.path.db+"/items.json"}),item_types:new node.nedb({filename:_g.path.db+"/item_types.json"}),item_type_collections:new node.nedb({filename:_g.path.db+"/item_type_collections.json"}),ships:new node.nedb({filename:_g.path.db+"/ships.json"}),ship_types:new node.nedb({filename:_g.path.db+"/ship_types.json"}),ship_type_collections:new node.nedb({filename:_g.path.db+"/ship_type_collections.json"}),ship_type_order:new node.nedb({filename:_g.path.db+"/ship_type_order.json"}),ship_classes:new node.nedb({filename:_g.path.db+"/ship_classes.json"}),ship_series:new node.nedb({filename:_g.path.db+"/ship_series.json"}),ship_namesuffix:new node.nedb({filename:_g.path.db+"/ship_namesuffix.json"}),updates:new node.nedb({filename:_g.path.db+"/updates.json"}),arsenal_weekay:new node.nedb({filename:_g.path.db+"/arsenal_weekay.json"})};_g.ship_type_order=[],_g.ship_type_order_map={},_g.statSpeed={5:"低速",10:"高速"},_g.statRange={1:"短",2:"中",3:"长",4:"超长"},_g.getStatSpeed=function(e){return e=parseInt(e),_g.statSpeed[e]},_g.getStatRange=function(e){return e=parseInt(e),_g.statRange[e]},_g.getName=function(e,a){return a=a||"",e?(e[_g.lang]||e.ja_jp)+(e.suffix?a+(_g.data.ship_namesuffix[e.suffix][_g.lang]||_g.data.ship_namesuffix[e.suffix].ja_jp):""):null},_g.log=function(e){debugmode&&console.log(e)},_frame.app_main={page:{},page_dom:{},bgimgs:[],loading:["dbs","bgimgs","db_namesuffix"],functions_on_ready:[],loaded:function(e,a){if(e){var t=_frame.app_main.loading.indexOf(e);t>-1&&(_frame.app_main.loading.splice(_frame.app_main.loading.indexOf(e),1),_frame.app_main.is_loaded=!1)}_frame.app_main.loading.length||_frame.app_main.is_loaded||(setTimeout(function(){!_frame.app_main.is_loaded||_frame.app_main.loading.length||$html.hasClass("app-ready")||(_frame.dom.layout.addClass("ready"),$html.addClass("app-ready"),setTimeout(function(){for(var e in _frame.app_main.functions_on_ready)_frame.app_main.functions_on_ready[e]()},1500))},a?300:1e3),this.window_event_bound||($window.on("popstate._global",function(e){if(e.originalEvent&&e.originalEvent.state)_frame.app_main.state(e.originalEvent.state);else{var a=location.search?location.search.split("?")[1]:"",t={};a=a.split("&");for(var n=0;n<a.length;n++){var s=a[n].split("=");t[s[0]]=s[1]||!0}_frame.app_main.window_event_bound||t.page||t.infos||_frame.app_main.load_page(_frame.app_main.nav[0].page),_frame.app_main.state(t)}}).trigger("popstate._global"),this.window_event_bound=!0),_frame.app_main.is_loaded=!0)},pushState:function(e,a,t){history.pushState(e,a,t),e.infos||_frame.infos.hide()},state:function(e){e.infos?_frame.infos.show_func(e.infos,e.id,null,e.infosHistoryIndex):_frame.infos.hide(),e.page&&this.load_page_func(e.page)},change_bgimg:function(e){function a(e){setTimeout(function(){e.remove()},_g.animate_duration_delay)}if(!_frame.app_main.bgimgs.length)return!1;var t=e&&e.length?e:_frame.app_main.bgimgs,n=t[_g.randInt(t.length)],s=_frame.app_main.cur_bgimg_el?_frame.app_main.cur_bgimg_el.css("background-image"):null;for(s=s?s.split("/"):null,s=s?s[s.length-1].split(")"):null,s=s?s[0]:null;n==s;)n=t[_g.randInt(t.length-1)];var i="file://"+encodeURI(node.path.join(_g.path.bgimg_dir,"/blured/"+n).replace(/\\/g,"/"));this.bgimg_path=node.path.join(_g.path.bgimg_dir,"/"+n),n="file://"+encodeURI(this.bgimg_path.replace(/\\/g,"/")),s&&a(_frame.app_main.cur_bgimg_el),_frame.app_main.cur_bgimg_el=$("<div/>").css("background-image","url("+n+")").appendTo(_frame.dom.bgimg).add($("<s"+(_frame.app_main.change_bgimg_fadein?' class="fadein"':"")+"/>").css("background-image","url("+i+")").appendTo(_frame.dom.nav)).add($("<s"+(_frame.app_main.change_bgimg_fadein?' class="fadein"':"")+"/>").css("background-image","url("+i+")").appendTo(_frame.dom.main)),_frame.dom.bg_controls&&(_frame.app_main.cur_bgimg_el=_frame.app_main.cur_bgimg_el.add($("<s"+(_frame.app_main.change_bgimg_fadein?' class="fadein"':"")+"/>").css("background-image","url("+i+")").appendTo(_frame.dom.bg_controls))),_frame.app_main.change_bgimg_fadein=!0},toggle_hidecontent:function(){_frame.dom.layout.toggleClass("hidecontent")},load_page:function(e){return _frame.app_main.cur_page!=e&&e?(this.pushState({page:e},null,"?page="+e),void this.load_page_func(e)):e},load_page_func:function(e){if(_g.log("PREPARE LOADING: "+e),_frame.app_main.cur_page==e||!e)return e;if(!_frame.app_main.page_dom[e]){_frame.app_main.page_dom[e]=$('<div class="page" page="'+e+'"/>').appendTo(_frame.dom.main);var a=node.fs.readFileSync(_g.path.page+e+".html","utf8");a&&(_frame.app_main.page_dom[e].html(a),_frame.app_main.page[e]&&_frame.app_main.page[e].init&&_frame.app_main.page[e].init(_frame.app_main.page_dom[e]),_p.initDOM(_frame.app_main.page_dom[e]))}_frame.app_main.page_dom[e].removeClass("off").trigger("pageon"),_frame.app_main.cur_page&&(_frame.dom.navs[_frame.app_main.cur_page].removeClass("on"),_frame.app_main.page_dom[_frame.app_main.cur_page].addClass("off").trigger("pageoff")),_frame.dom.navs[e].addClass("on"),_frame.dom.layout.hasClass("ready")&&_frame.app_main.change_bgimg(),_frame.app_main.cur_page=e,_g.log("LOADED: "+e)},only_bg_on:function(){return this.only_bg?!0:(_frame.dom.bg_controls||(_frame.dom.bg_controls=$('<div class="bg_controls"/>').on("transitionend.only_bg_off",function(e){e.currentTarget==e.target&&"top"==e.originalEvent.propertyName&&_frame.dom.layout.hasClass("only_bg")&&$(this).offset().top>=$body.height()&&(_frame.dom.layout.removeClass("only_bg"),_frame.app_main.only_bg=!1)}).appendTo(_frame.dom.layout),_frame.app_main.cur_bgimg_el=_frame.app_main.cur_bgimg_el.add(_frame.app_main.cur_bgimg_el.eq(0).clone().appendTo(_frame.dom.bg_controls)),$('<button class="prev" icon="arrow-left"/>').on("click",function(){var e=node.path.parse(_frame.app_main.bgimg_path),a=$.inArray(e.base,_frame.app_main.bgimgs)-1;0>a&&(a=_frame.app_main.bgimgs.length-1),_frame.app_main.change_bgimg([_frame.app_main.bgimgs[a]])}).appendTo(_frame.dom.bg_controls),$('<button class="back"/>').html("返回").on("click",function(){_frame.app_main.only_bg_off()}).appendTo(_frame.dom.bg_controls),$('<button class="back"/>').html("保存图片").on("click",function(){var e=node.path.parse(_frame.app_main.bgimg_path),a=$.inArray(e.base,_frame.app_main.bgimgs);_g.file_save_as(_frame.app_main.bgimg_path,a+1+e.ext)}).appendTo(_frame.dom.bg_controls),$('<button class="next" icon="arrow-right"/>').on("click",function(){var e=node.path.parse(_frame.app_main.bgimg_path),a=$.inArray(e.base,_frame.app_main.bgimgs)+1;a>=_frame.app_main.bgimgs.length&&(a=0),_frame.app_main.change_bgimg([_frame.app_main.bgimgs[a]])}).appendTo(_frame.dom.bg_controls)),_frame.dom.layout.addClass("only_bg"),setTimeout(function(){_frame.dom.bg_controls.addClass("on")},10),void(this.only_bg=!0))},only_bg_off:function(){return this.only_bg?void _frame.dom.bg_controls.removeClass("on"):!0},only_bg_toggle:function(){return this.only_bg?this.only_bg_off():this.only_bg_on()},init:function(){if(_frame.app_main.is_init)return!0;if(_frame.dom.nav=$("<nav/>").appendTo(_frame.dom.layout),_frame.dom.logo=$('<button class="logo" />').on({"animationend, webkitAnimationEnd":function(){$(this).addClass("ready-animated")}}).appendTo(_frame.dom.nav),_frame.dom.navlinks=$("<div/>").appendTo(_frame.dom.nav),_frame.dom.globaloptions=$('<section class="options"/>').appendTo(_frame.dom.nav),_frame.dom.btnShowOnlyBg=$('<button class="show_only_bg" icon="images"/>').on("click",function(){_frame.app_main.only_bg_toggle()}).appendTo(_frame.dom.globaloptions),_frame.dom.btnShowOnlyBgBack=$('<button class="show_only_bg_back" icon="arrow-set2-left"/>').on("click",function(){_frame.app_main.only_bg_off()}).appendTo(_frame.dom.nav),_frame.dom.main=$("<main/>").appendTo(_frame.dom.layout),_frame.dom.bgimg=$('<div class="bgimg" />').appendTo(_frame.dom.layout),_frame.app_main.nav&&_frame.app_main.nav.length){_frame.dom.navs={};for(var e in _frame.app_main.nav){var a=_frame.app_main.nav[e];_frame.dom.navs[a.page]=function(e){return $("<button />").on("click",function(){_frame.app_main.load_page(e)})}(a.page).html(a.title).appendTo(_frame.dom.navlinks)}}var t=Q.fcall(function(){});t.then(function(){_g.log("背景图: START");var e=Q.defer();return node.fs.readdir(_g.path.bgimg_dir,function(a,t){if(a)e.reject(new Error(a));else{var n=_config.get("bgimgs"),s=[];n=n?n.split(","):[];for(var i in t){var o=node.fs.lstatSync(node.path.join(_g.path.bgimg_dir,"/"+t[i]));if(!o.isDirectory())if(_frame.app_main.bgimgs.push(t[i]),n.length)$.inArray(t[i],n)<0&&s.push(t[i]);else{var r=parseInt(o.ctime.valueOf());s.length?r>s[1]&&(s=[t[i],r]):s=[t[i],r]}}n.length||s.pop(),_config.set("bgimgs",_frame.app_main.bgimgs),_frame.app_main.change_bgimg(s),_frame.app_main.loaded("bgimgs"),_g.log("背景图: DONE"),e.resolve()}}),e.promise}).then(function(){_g.log("Preload All DBs: START");var e=[],a=[],t=0;for(var n in _db)a.push(n);return a.forEach(function(n){function s(e){_g.log("DB "+e+" DONE"),i.resolve(),t++,t>=a.length&&(_g.log("Preload All DBs: DONE"),setTimeout(function(){_frame.app_main.loaded("dbs")},100))}var i=Q.defer();_db[n].loadDatabase(function(e){if(e)i.reject(new Error(e));else switch(n){case"ship_namesuffix":_db.ship_namesuffix.find({}).sort({id:1}).exec(function(e,a){e?i.reject(new Error(e)):(_g.data.ship_namesuffix=[{}].concat(a),_frame.app_main.loaded("db_namesuffix"),s(n))});break;case"ship_type_order":_db.ship_type_order.find({}).sort({id:1}).exec(function(e,a){if(e)i.reject(new Error(e));else{for(var t in a)_g.ship_type_order.push(a[t].types.length>1?a[t].types:a[t].types[0]),_g.data.ship_type_order[t]=a[t];!function(){for(var e in _g.ship_type_order){var a=parseInt(e);if("object"==typeof _g.ship_type_order[e])for(var t in _g.ship_type_order[e])_g.ship_type_order_map[_g.ship_type_order[e][t]]=a;else _g.ship_type_order_map[_g.ship_type_order[e]]=a}}(),_db.ships.find({}).sort({type:1,"class":1,class_no:1,time_created:1,"name.suffix":1}).exec(function(a,t){function o(e){for(var a=0;_g.data.ship_id_by_type[e]&&_g.data.ship_id_by_type[e][a];){var t,n=_g.data.ship_id_by_type[e][a];if(_g.data.ships[n].remodel_next&&_g.data.ships[_g.data.ships[n].remodel_next]&&_g.data.ships[n].remodel_next!=_g.data.ship_id_by_type[e][a+1]&&(t=$.inArray(_g.data.ships[n].remodel_next,_g.data.ship_id_by_type[e]))>-1){_g.log(n+", "+_g.data.ships[n].remodel_next+", "+t),_g.data.ship_id_by_type[e].splice(t,1),_g.data.ship_id_by_type[e].splice($.inArray(n,_g.data.ship_id_by_type[e])+1,0,_g.data.ships[n].remodel_next),console.log(_g.data.ship_id_by_type[e]),o(e);break}a>=_g.data.ship_id_by_type[e].length-2?(e++,a=0):a++}}if(a)i.reject(new Error(e));else{for(var r in t)_g.data.ships[t[r].id]=t[r],"undefined"==typeof _g.data.ship_id_by_type[_g.ship_type_order_map[t[r].type]]&&(_g.data.ship_id_by_type[_g.ship_type_order_map[t[r].type]]=[]),_g.data.ship_id_by_type[_g.ship_type_order_map[t[r].type]].push(t[r].id);o(0),s(n)}})}});break;case"updates":"undefined"==typeof _g.data[n]&&(_g.data[n]={}),s(n);break;default:_db[n].find({},function(e,a){if(e)i.reject(new Error(e));else{"undefined"==typeof _g.data[n]&&(_g.data[n]={});for(var t in a)_g.data[n][a[t].id]=a[t];s(n)}})}}),e.push(i.promise)}),Q.all(e)}).then(function(){return _g.log("数据更新检查: START"),global.launcherOptions&&global.launcherOptions.dataUpdated?global.launcherOptions.dataUpdated:{}}).then(function(e){var a=[],t=[],n=0,s=$();for(var i in e){for(var o=e[i].split("."),r="",p=0;p<Math.min(3,o.length);p++)r+="."+o[p];r=r.substr(1),t.push({type:i,version:r})}return t.length?(t.forEach(function(e){function i(e){_g.log("数据更新检查: "+e+" DONE"),o.resolve(),n++,n>=t.length&&(s.length?(_g.log("数据更新检查: DONE"),_frame.app_main.functions_on_ready.push(function(){_frame.modal.show($('<div class="updates"/>').append(s).on("click.infosHideModal","[data-infos]",function(){_frame.modal.hide()}),"<span>更新日志</span>",{classname:"update_journal"})})):_g.log("数据更新检查: DONE，无更新日志"))}var o=Q.defer();_db.updates.find(e).sort({date:-1}).exec(function(a,t){if(a)o.reject(new Error(a));else{for(var n in t){var r=$('<section class="update_journal" data-version-'+t[n].type+'="'+t[n].version+'"/>').html(_frame.app_main.page.about.journaltitle(t[n]));try{$(_frame.app_main.page.about.journal_parse(t[n].journal)).appendTo(r)}catch(p){_g.error(p),r.remove()}s=s.add(r)}i(e.type+" - "+e.version)}}),a.push(o.promise)}),Q.all(a)):(_g.log("数据更新检查: DONE，无数据更新"),!1)}).then(function(){return!0}).then(function(){function e(e){var a=e.pushState;e.pushState=function(t){return"function"==typeof e.onpushstate&&e.onpushstate({state:t}),setTimeout(function(){_frame.dom.hashbar.trigger("urlchanged")},1),a.apply(e,arguments)}}return debugmode&&(_frame.dom.hashbar=$('<input type="text"/>').on({urlchanged:function(){$(this).val(location.href.substr((location.origin+location.pathname).length))},change:function(){location.replace(location.origin+location.pathname+_frame.dom.hashbar.blur().val())}}).appendTo($('<div class="debug_hashbar"/>').appendTo(_frame.dom.layout)).trigger("urlchanged"),_frame.dom.layout.addClass("debug-hashbar"),$window.on({"hashchange.debug_mode_hashbar":function(){_frame.dom.hashbar.trigger("urlchanged")},"popstate.debug_mode_hashbar":function(){_frame.dom.hashbar.trigger("urlchanged")}}),e(window.history)),!0}).catch(function(e){_g.error(e)}).done(function(){_g.log("Global initialization DONE")}),_frame.app_main.is_init=!0}},_g.error=function(e){_g.log(e),node.fs.appendFileSync(node.path.join(_g.execPath,"errorlog.txt"),new Date+"\r\n"+(e instanceof Error?e.message||"":e)+"\r\n\r\n========================================\r\n\r\n")};var _updater={local_versions:{},remote_root:"http://fleet.diablohu.com",remote_url:"http://fleet.diablohu.com/versions.json",remote_data:{}};_updater.get_local_version=function(){return _updater.local_versions=JSON.parse(localStorage["nwjs-data-version"]||"{}"),_updater.local_versions},_updater.get_remote=function(){var e=Q.defer();return node.request({uri:_updater.remote_url,method:"GET"},function(a,t,n){a?e.reject(new Error(a)):200!=t.statusCode?e.reject(new Error(t.statusCode)):(_updater.remote_data=JSON.parse(n||"{}")||{},e.resolve(_updater.remote_data))}),e.promise},_updater.get_packages_updated=function(){function e(e,a){var t,n;if(typeof e+typeof a!="stringstring")return!1;for(e=e.split("."),a=a.split("."),t=0,n=Math.max(e.length,a.length);n>t;t++){if(e[t]&&!a[t]&&parseInt(e[t])>0||parseInt(e[t])>parseInt(a[t]))return 1;if(a[t]&&!e[t]&&parseInt(a[t])>0||parseInt(e[t])<parseInt(a[t]))return-1}return 0}var a=[];for(var t in _updater.local_versions)if(_updater.remote_data.packages&&_updater.remote_data.packages[t]){var n=_updater.remote_data.packages[t].version?_updater.remote_data.packages[t].version:_updater.remote_data.packages[t];e(n,_updater.local_versions[t])>0&&a.push(t)}return a.sort(function(e,a){return _updater.remote_data.packages[e].bytes-_updater.remote_data.packages[a].bytes})},_updater.create_update_indicator=function(){_updater.update_indicator&&_updater.update_indicator.length||(_updater.update_indicator=$('<button class="update_progress" icon="stairs-up" data-tip="检测到新版本<br>更新中..."/>').appendTo(_frame.dom.globaloptions),_updater.update_indicator_bar=$("<s/>").appendTo(_updater.update_indicator))},_updater.update=function(){var e=Q.fcall(function(){}),a=node.path.dirname(process.execPath).split(node.path.sep),t="",n=!1;a="darwin"==process.platform||"nwjs"==a[a.length-1]&&"nw.exe"==node.path.basename(process.execPath)?process.cwd():node.path.dirname(process.execPath),t=node.path.join(a,"data"),e.then(function(){var e=Q.defer();return node.fs.lstat(t,function(a,t){a||!t.isDirectory()?e.reject("数据包目录不存在, 不进行自动更新"):(n=!0,e.resolve(!0))}),e.promise}).then(function(){var e=Q.defer();return node.fs.readdir(t,function(a,t){if(a)e.reject(a);else{var n=[];for(var s in t)".updated"==node.path.extname(t[s])&&n.push(t[s]);e.resolve(n)}}),e.promise}).then(function(e){var a=[];return e.forEach(function(e){var n=Q.defer();node.fs.unlink(node.path.join(t,e),function(){_g.log("已删除更新残留文件 "+e),n.resolve()}),a.push(n.promise)}),Q.all(a)}).then(_updater.get_local_version()).then(_updater.get_remote).then(_updater.get_packages_updated).then(function(e){if(!e.length)return _g.log("所有数据包均为最新"),!1;_g.log("自动更新过程开始 ("+e.join(", ")+")"),_updater.create_update_indicator();var a=Q.fcall(function(){}),n=0,s=0,i=0;e.forEach(function(o){!function(n,o){s+=_updater.remote_data.packages[n].bytes,a=a.then(function(){function a(e,a){a=a||"",-4048==e.errno||e.message.indexOf("not permitted")>-1?_g.log("    "+a+"权限不足"):(_g.log(e),_g.log("    "+a+"发生错误 ["+e.errno+"]: "+e.message))}var r=Q.defer(),p=!1,_=node.path.join(t,n+node.path.extname(_updater.remote_data.packages[n].path)+".updated"),d=node.path.join(t,n+node.path.extname(_updater.remote_data.packages[n].path));return _g.log(""),_g.log("========== "+o+"/"+e.length+" =========="),_g.log(""),_g.log("    "+n+" | 本地版本: "+_updater.local_versions[n]+" | 服务器版本: "+(_updater.remote_data.packages[n].version?_updater.remote_data.packages[n].version:_updater.remote_data.packages[n])),node["request-progress"](node.request({uri:node.url.format(_updater.remote_root+"/"+_updater.remote_data.packages[n].path),method:"GET"}).on("error",function(e){_g.log("    下载数据包出错"),node.fs.unlink(_,function(){r.reject(new Error(e))})}).on("response",function(e){200==e.statusCode&&parseInt(e.headers["content-length"])==_updater.remote_data.packages[n].bytes&&(p=!0)})).on("error",function(e){_g.log("    下载数据包出错"),node.fs.unlink(_,function(){r.reject(new Error(e))})}).on("progress",function(e){_updater.update_indicator.addClass("on"),_g.log("    "+e.received+" / "+e.total+" ("+e.percent+"%) | "+Math.floor((i+e.received)/s*100)+"%"),_updater.update_indicator_bar.css("width",Math.floor((i+e.received)/s*100)+"%")}).pipe(node.fs.createWriteStream(_).on("finish",function(){p?(i+=_updater.remote_data.packages[n].bytes,node.fs.unlink(d,function(e){e&&(a(e,"删除原有数据包"),_g.log("    跳过")),node.fs.rename(_,d,function(e){e?(a(e,"重命名新数据包"),_g.log("    跳过")):_g.log("    该数据包更新完成"),r.resolve()})})):(_g.log("    下载数据包出错"),node.fs.unlink(_,function(){r.resolve()}))}).on("error",function(e){a(e,"写入文件"),_g.log("    流程结束"),r.reject(new Error(e))})),r.promise})}(o,n),n++}),a=a.catch(function(e){_g.error(e),_g.log("自动更新失败"),_updater.update_indicator.removeClass("on")}).done(function(){_g.log(""),i>=s?(_g.log("========== "+e.length+"/"+e.length+" =========="),_g.log(""),_g.log("自动更新完毕"),_updater.update_indicator.addClass("done").data("tip","更新完成<br>请重新启动程序"),_updater.update_indicator_bar.css("width","")):(_g.log("========== "+e.length+"/"+e.length+" =========="),_g.log(""),_g.log("自动更新失败, 结束流程"),_updater.update_indicator.removeClass("on"))})}).catch(function(e){_g.error(e),_g.log("自动更新失败"),_updater.update_indicator&&_updater.update_indicator.length&&_updater.update_indicator.remove()}).done(function(){_g.log("自动更新过程初始化完毕")})},_frame.app_main.functions_on_ready.push(_updater.update),_tmpl.link_equipment=function(e,a,t,n){if(!e)return!1;if(a&&"object"==typeof a)return _tmpl.link_equipment(e,a.tagName||null,a.returnHTML||null,"undefined"==typeof a.improvementStar?null:a.improvementStar);if(a=a||"button",t=t||!1,n="undefined"==typeof n?null:n,"object"!=typeof e){var s=parseInt(e);e=_g.data.items[s]}else var s=e.id;return _tmpl.export("<"+a+' class="link_equipment" data-equipmentid="'+s+'" data-tip-position="right" data-infos="[[EQUIPMENT::'+s+']]" data-tip="[[EQUIPMENT::'+s+']]"><i style="background-image:url(assets/images/itemicon/'+_g.data.item_types[e.type].icon+'.png)"></i><small>'+e.name.zh_cn.replace(/（([^（^）]+)）/g,"<small>($1)</small>")+"</small>"+(null!==n?"<em"+(0>=n?' class="zero"':"")+">+"+n+"</em>":"")+"</"+a+">",t)},_tmpl.link_ship=function(e,a,t){if(!e)return!1;if(a&&"object"==typeof a)return _tmpl.link_ship(e,a.tagName||null,a.returnHTML||null);if(a=a||"button",t=t||!1,"object"!=typeof e){var n=parseInt(e);e=_g.data.ships[n]}else var n=e.id;return _tmpl.export("<"+a+' class="link_ship" data-shipid="'+n+'" data-infos="[[SHIP::'+n+']]"><img src="'+node.path.normalize(_g.path.pics.ships+"/"+n)+'/0.webp"/><span>'+(e.type?"<small>"+_g.data.ship_types[e.type].full_zh+"</small>":"")+_g.getName(e.name,"・")+"</span></"+a+">",t)},_tmpl.textlink_ship=function(e,a,t){if(!e)return!1;if(a&&"object"==typeof a)return _tmpl.link_ship(e,a.tagName||null,a.returnHTML||null);if(a=a||"a",t=t||!1,"object"!=typeof e){var n=parseInt(e);e=_g.data.ships[n]}else var n=e.id;return _tmpl.export("<"+a+' href="?infos=ship&id='+n+'" data-shipid="'+n+'" data-infos="[[SHIP::'+n+']]">'+(e.type?"["+_g.data.ship_types[e.type].full_zh+"] ":"")+_g.getName(e.name,"・")+"</"+a+">",t)},_frame.app_main.page.ships={},_frame.app_main.page.ships.init=function(e){this.tablelist=e.find(".tablelist"),this.tablelistObj=this.tablelist.data("tablelist"),e.on("pageon",function(){_frame.app_main.page.ships.tablelistObj||(_frame.app_main.page.ships.tablelistObj=_frame.app_main.page.ships.tablelist.data("tablelist")),_frame.app_main.page.ships.tablelistObj&&_frame.app_main.page.ships.tablelistObj.thead_redraw()})},_frame.app_main.page.equipments={},_frame.app_main.page.equipments.init=function(e){this.tablelist=e.find(".tablelist"),this.tablelistObj=this.tablelist.data("tablelist"),e.on("pageon",function(){_frame.app_main.page.equipments.tablelistObj||(_frame.app_main.page.equipments.tablelistObj=_frame.app_main.page.equipments.tablelist.data("tablelist")),_frame.app_main.page.equipments.tablelistObj&&_frame.app_main.page.equipments.tablelistObj.thead_redraw()})},_frame.app_main.page.equipments.gen_helper_equipable_on=function(e){var a="";for(var t in _g.data.item_types[e].equipable_on_type){var n=_g.data.item_types[e].equipable_on_type[t];a+="<span>"+_g.data.ship_types[n].full_zh+(parseInt(t)<_g.data.item_types[e].equipable_on_type.length-1?",&nbsp;":"")+"</span>"}return'<em class="helper" data-tip="<h4 class=item_equipable_on>可装备于</h4>'+a+'">?</em>'},_frame.app_main.page.about={},_frame.app_main.page.about.journal_parse=function(e){for(var a,t=/\[\[([^\:]+)\:([0-9]+)\]\]/gi,n=markdown.toHTML(e);null!==(a=t.exec(e));)try{n=n.replace(a[0],_tmpl["link_"+a[1].toLowerCase()](a[2],null,!0))}catch(s){}for(a=null,t=/\[\[([^\:]+)\:([0-9]+)\:TEXT\]\]/gi;null!==(a=t.exec(e));)try{n=n.replace(a[0],_tmpl["textlink_"+a[1].toLowerCase()](a[2],null,!0))}catch(s){}return n},_frame.app_main.page.about.journaltitle=function(e,a){return e=e||{},a=a||"h3","<h3>"+(e.hotfix?"HOTFIX - ":"")+("app"==e.type?"":("app-db"==e.type?"DB":e.type).toUpperCase()+" / ")+e.version+"<small>"+(e.date?e.date:"WIP")+"</small></h3>"},_frame.app_main.page.about.init=function(e){function a(a){var t=$('<section class="update_journal" data-version-'+a.type+'="'+a.version+'"/>').html(_frame.app_main.page.about.journaltitle(a)).appendTo(e);try{$(_frame.app_main.page.about.journal_parse(a.journal)).appendTo(t)}catch(n){_g.error(n),t.remove()}}var t=Q.fcall(function(){});t.then(function(){var e=Q.defer();return _db.updates.find({date:""}).sort({date:-1}).exec(function(t,n){for(var s in n)a(n[s]);e.resolve(t)}),e.promise}).then(function(){var e=Q.defer();return _db.updates.find({$not:{date:""}}).sort({date:-1}).exec(function(t,n){for(var s in n)a(n[s]);e.resolve(t)}),e.promise})},_frame.infos={historyLength:-1,historyCurrent:-1,contentCache:{},getContent:function(e,a){return this.contentCache[e]||(this.contentCache[e]={}),this.contentCache[e][a]||(this.contentCache[e][a]=_p.initDOM(_frame.infos["__"+e](a))),this.contentCache[e][a]},show:function(e,a,t){var n=/^\[\[([^\:]+)\:\:([0-9]+)\]\]$/.exec(e),s=null,i=null;if(!(n&&n.length>2))return!1;switch(s=n[1].toLowerCase(),i=parseInt(n[2]),s){case"item":case"equip":s="equipment"}return this.curContent==s+"::"+i?_frame.infos.dom.container.children("div:first-child"):(t||(this.historyCurrent++,this.historyLength=this.historyCurrent,_frame.app_main.pushState({infos:s,id:i,infosHistoryIndex:_frame.infos.historyCurrent},null,"?infos="+s+"&id="+i)),void this.show_func(s,i,t))},show_func:function(e,a,t,n){if(!e||!a)return!1;if(this.curContent==e+"::"+a)return _frame.infos.dom.container.children("div:first-child");e=e.toLowerCase(),a=parseInt(a);var s="";switch(_frame.infos.dom||(_frame.infos.dom={nav:$('<div class="infos"/>').appendTo(_frame.dom.nav),main:$('<div class="page infos"/>').appendTo(_frame.dom.main)},_frame.infos.dom.container=$('<div class="wrapper"/>').appendTo(_frame.infos.dom.main),_frame.infos.dom.back=$('<button class="back" icon="arrow-set2-left"/>').on({click:function(){_frame.infos.dom.forward.removeClass("disabled"),history.back()},"transitionend.infos_hide":function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==parseInt(_frame.infos.dom.back.css("opacity"))&&_frame.infos.hide_finish()}}).appendTo(_frame.infos.dom.nav),_frame.infos.dom.forward=$('<button class="forward disabled" icon="arrow-set2-right"/>').on("click",function(){history.forward()}).appendTo(_frame.infos.dom.nav)),n="undefined"!=typeof n?n:this.historyCurrent,this.historyCurrent=n,this.historyCurrent==this.historyLength&&this.historyCurrent>-1&&_frame.infos.dom.forward.addClass("disabled"),_frame.dom.layout.addClass("infos-show"),e){case"ship":s=this.getContent(e,a),_frame.infos.dom.main.attr("data-infostype","shipinfo");break;case"equipment":s=this.getContent(e,a),_frame.infos.dom.main.attr("data-infostype","equipmentinfo")}var i=(s.append?s[0].outerHTML.hashCode():s.hashCode(),s.append?s:$(s));i.on("transitionend.hide",function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==parseInt(i.css("opacity"))&&i.detach()}).prependTo(_frame.infos.dom.container),this.curContent=e+"::"+a,_frame.app_main.cur_page&&(this.lastCurrentPage=_frame.app_main.cur_page,_frame.dom.navs[_frame.app_main.cur_page].removeClass("on"),_frame.app_main.cur_page=null),setTimeout(function(){_frame.dom.layout.addClass("infos-on")},1)},hide:function(){return _frame.infos.dom&&this.curContent?(_frame.dom.layout.removeClass("infos-on"),_frame.infos.dom.forward.addClass("disabled"),this.curContent=null,void(this.lastCurrentPage&&(_frame.dom.navs[this.lastCurrentPage].addClass("on"),_frame.app_main.cur_page=this.lastCurrentPage))):!1},hide_finish:function(){return _frame.infos.curContent?!1:(_frame.dom.layout.removeClass("infos-show"),_frame.infos.dom.main.attr("data-infostype",""),this.historyLength=-1,void(this.historyCurrent=-1))},historyback:function(){_frame.infos.dom.main.children().slice(1).remove(),_frame.infos.dom.main.children().eq(0).removeClass("off").addClass("fadein"),_frame.infos.dom.historyback.empty().removeClass("show"),_frame.infos.dom.main.children().eq(0).hasClass("ship")?_frame.infos.dom.main.attr("data-infostype","shipinfo"):_frame.infos.dom.main.children().eq(0).hasClass("equipment")&&_frame.infos.dom.main.attr("data-infostype","equipmentinfo")}},_frame.infos.init=function(){return _frame.infos.is_init?!0:($body.on("click._infos","[data-infos]",function(e){if("input"!=e.target.tagName.toLowerCase()||"compare"!=e.target.className){var a=$(this);_frame.infos.show(a.attr("data-infos"),a,a.attr("data-infos-nohistory")),"a"==e.target.tagName.toLowerCase()&&e.preventDefault()}}),_frame.infos.is_init=!0,!0)},_frame.infos.__ship=function(e){function a(e,a){return a||0!=e&&"0"!=e?-1==e||"-1"==e?'<small class="zero">?</small>':e:'<small class="zero">-</small>'}function t(e,t,s){function i(e,a,t){return 0>a||0>t?-1:Math.floor(a+(t-a)*e/99)}var o=0,r=null;switch(e){case"hp":o=a(n.stat.hp),r=n.stat.hp>=90?n.stat.hp+9:n.stat.hp>=70?n.stat.hp+8:n.stat.hp>=50?n.stat.hp+7:n.stat.hp>=40?n.stat.hp+6:n.stat.hp>=30?n.stat.hp+5:n.stat.hp+4,r>n.stat.hp_max&&(r=n.stat.hp_max);break;case"asw":o=a(i(99,n.stat.asw,n.stat.asw_max),/^(5|8|9|12|24)$/.test(n.type)),r=a(i(150,n.stat.asw,n.stat.asw_max),/^(5|8|9|12|24)$/.test(n.type));break;case"evasion":case"los":o=a(i(99,n.stat[e],n.stat[e+"_max"])),r=a(i(150,n.stat[e],n.stat[e+"_max"]));break;case"speed":o=_g.getStatSpeed(n.stat.speed);break;case"range":o=_g.getStatRange(n.stat.range);break;case"luck":o=n.stat.luck+"<sup>"+n.stat.luck_max+"</sup>",r=n.stat.luck+3+"<sup>"+n.stat.luck_max+"</sup>";break;case"fuel":case"ammo":o=a(n.consum[e]),r=a(Math.floor(.85*n.consum[e]));break;default:o=a(n.stat[e+"_max"]||n.stat[e])}$("<span/>").html('<small class="stat-'+e+'">'+t+"</small><em"+(r?' class="lvl99"':"")+">"+o+"</em>"+(r?'<em class="lvl150">'+r+"</em>":"")).appendTo(s)}var n=_g.data.ships[e];_g.log(n);var s=$('<div class="ship"/>'),i=_g.getName(n.name,"・")||"舰娘",o=[],r=n.no&&parseInt(n.no)<500?!0:!1;$('<div class="title"/>').html('<h2 data-content="'+i+'">'+i+'</h2><small><span data-tip="'+(r?"图鉴编号":"无图鉴编号")+'">No.'+(r?n.no:"-")+"</span>"+(n["class"]?_g.data.ship_classes[n["class"]].name_zh+"级":"")+(n.class_no?"<em>"+n.class_no+"</em>号舰":"")+(n.type?" / "+_g.data.ship_types[n.type].full_zh:"")+"</small>").appendTo(s);var p="_input_g"+parseInt(_g.inputIndex),_="_input_g"+(parseInt(_g.inputIndex)+1),d=parseInt(_config.get("ship_infos_lvl")||99),l=$('<div class="stats"/>').html('<div class="title"><h4 data-content="基础属性">基础属性</h4><span><label for="'+p+'" class="lvl99">99</label><label for="'+_+'" class="lvl150">150</label></span></div>').prepend($('<input type="radio" name="ship_infos_lvl_'+e+'" id="'+p+'" value="99"/>').prop("checked",99==d).on("change",function(){_config.set("ship_infos_lvl",$(this).val())})).prepend($('<input type="radio" name="ship_infos_lvl_'+e+'" id="'+_+'" value="150"/>').prop("checked",150==d).on("change",function(){_config.set("ship_infos_lvl",$(this).val())})).appendTo(s),m=$('<div class="stat"/>').appendTo(l),c=$('<div class="stat"/>').appendTo(l),h=$('<div class="stat"/>').appendTo(l),f=$('<div class="stat consum"/>').appendTo(l);_g.inputIndex+=2,t("hp","耐久",m),t("armor","装甲",m),t("evasion","回避",m),t("carry","搭载",m),t("fire","火力",c),t("torpedo","雷装",c),t("aa","对空",c),t("asw","对潜",c),t("speed","航速",h),t("range","射程",h),t("los","索敌",h),t("luck","运",h),t("fuel","油耗",f),t("ammo","弹耗",f);for(var u=$('<div class="equipments"/>').html('<h4 data-content="初始装备 & 搭载量">初始装备 & 搭载量</h4>').appendTo(s),g=0;4>g;){var b=$("<button/>").appendTo(u),v=$("<i/>").appendTo(b),y=$("<small/>").appendTo(b),k=$("<em/>").appendTo(b);if("undefined"==typeof n.slot[g])b.addClass("no");else if("undefined"!=typeof n.equip[g]&&n.equip[g]&&""!==n.equip[g]){var T=_g.data.items[n.equip[g]],w="assets/images/itemicon/"+_g.data.item_types[T.type].icon+".png";b.attr({"data-equipmentid":n.equip[g],"data-tip-position":"left","data-infos":"[[EQUIPMENT::"+n.equip[g]+"]]","data-tip":"[[EQUIPMENT::"+n.equip[g]+"]]"}),y.html(T.name.zh_cn.replace(/（([^（^）]+)）/g,"<small>($1)</small>")),k.html(n.slot[g]),v.css("background-image","url("+w+")")}else b.addClass("empty"),y.html("--未装备--"),k.html(n.slot[g]);g++}var x=$('<div class="modernization"/>').html('<h4 data-content="合成">合成</h4>').appendTo(u),l=$('<div class="stats"/>').appendTo(x),C=!1;for(var g in n.modernization)if(n.modernization[g]){C=!0;var q;switch(parseInt(g)){case 0:q="fire";break;case 1:q="torpedo";break;case 2:q="aa";break;case 3:q="armor"}$('<span class="stat-'+q+'"/>').html("+"+n.modernization[g]).appendTo(l)}163==n.id&&$('<span class="stat-luck"/>').html("+1.2").appendTo(l),402==n.id&&$('<span class="stat-luck"/>').html("+1.6").appendTo(l),C||x.addClass("no").append($("<em/>").html("-")),$('<span class="entity"/>').html("<strong>声优</strong><span>"+(n.rels.cv?_g.data.entities[n.rels.cv].name[_g.lang]:"?")+"</span>").appendTo(s),$('<span class="entity"/>').html("<strong>画师</strong><span>"+(n.rels.illustrator?_g.data.entities[n.rels.illustrator].name[_g.lang]:"?")+"</span>").appendTo(s);
var j=$('<div class="remodels"/>').html('<h4 data-content="改造">改造</h4>').appendTo(s),I=_p.el.flexgrid.create().appendTo(j);n.series&&_db.ship_series.find({id:n.series},function(e,a){function t(e){e=e.replace(/\\/g,"/");try{var a=node.fs.lstatSync(e);a&&a.isFile()&&(h++,$('<input type="radio" name="ship_'+n.id+'_illustrations" value="'+h+'"/>').prop("checked",1==h).insertBefore(E),$('<span class="container"/>').html('<img src="'+e+'" data-filename="'+i+" - "+h+'.webp"/>').appendTo(E))}catch(t){}}if(!e&&a&&a.length){for(var s in a[0].ships){var r=parseInt(s),p=_g.data.ships[a[0].ships[s].id],_=p.name.zh_cn+(p.name.suffix?"・"+_g.data.ship_namesuffix[p.name.suffix].zh_cn:""),d='<h3 class="shipinfo"><strong data-content="'+_+'">'+_+"</strong>"+(p.type?"<small>"+_g.data.ship_types[p.type].full_zh+"</span>":"")+"</h3>",l=r?a[0].ships[r-1].next_lvl:null,m=r?a[0].ships[r-1].next_blueprint:null;if(I.appendDOM($('<button class="unit" data-shipid="'+a[0].ships[s].id+'"/>').attr({"data-infos":"[[SHIP::"+a[0].ships[s].id+"]]","data-tip":d,"data-infos-nohistory":!0}).addClass(a[0].ships[s].id==n.id?"on":"").addClass(m?"blueprint":"").html('<i><img src="'+_g.path.pics.ships+"/"+a[0].ships[s].id+'/0.webp"/></i>'+(l?"<strong>"+l+"</strong>":""))),a[0].ships[s].id==n.id)if(a[0].ships[s].illust_delete){if(r&&(o.push(a[0].ships[r-1].id),a[0].ships[r-1].illust_extra&&a[0].ships[r-1].illust_extra.length&&a[0].ships[r-1].illust_extra[0]))for(var c in a[0].ships[r-1].illust_extra)o.push("extra_"+a[0].ships[r-1].illust_extra[c])}else if(o.push(a[0].ships[s].id),a[0].ships[s].illust_extra&&a[0].ships[s].illust_extra.length&&a[0].ships[s].illust_extra[0])for(var c in a[0].ships[s].illust_extra)o.push("extra_"+a[0].ships[s].illust_extra[c])}var h=0;for(var s in o)t(_g.path.pics.ships+"/"+o[s]+"/8.webp"),t(_g.path.pics.ships+"/"+o[s]+"/9.webp")}});var S=$('<aside class="illustrations"/>').appendTo(s),E=$("<div/>").appendTo(S);return s},_frame.infos.__equipment=function(e){function a(e,a){if(t.stat[e]){var n='<small class="stat-'+e+'">'+a+"</small>";switch(e){case"range":n+="<em>"+_g.getStatRange(t.stat[e])+"</em>";break;default:var s=parseInt(t.stat[e]);n+="<em"+(0>s?' class="negative"':"")+">"+(s>0?"+":"")+s+"</em>"}$("<span/>").html(n).appendTo(i)}}var t=_g.data.items[e];_g.log(t);var n=$('<div class="equipment"/>');$('<div class="title"/>').html('<h2 data-content="'+t.name.zh_cn+'">'+t.name.zh_cn+'</h2><small><span data-tip="图鉴编号">No.'+t.id+"</span>"+(t.type?_g.data.item_types[t.type].name.zh_cn+_frame.app_main.page.equipments.gen_helper_equipable_on(t.type):"")+"</small>").appendTo(n);var s=$('<div class="stats"/>').html('<h4 data-content="属性">属性</h4>').appendTo(n),i=$('<div class="stat"/>').appendTo(s);a("fire","火力"),a("torpedo","雷装"),a("aa","对空"),a("asw","对潜"),a("bomb","爆装"),a("hit","命中"),a("armor","装甲"),a("evasion","回避"),a("los","索敌"),a("range","射程");var o=$('<div class="stats"/>').html('<h4 data-content="开发改修">开发改修</h4>').appendTo(n),r=$('<div class="stat"/>').appendTo(o);if($("<span/>").append($('<small class="indicator">').addClass(t.craftable?"true":"false").html(t.craftable?"可开发":"不可开发")).appendTo(r),$("<span/>").append($('<small class="indicator">').addClass(t.improvable?"true":"false").html(t.improvable?"可改修":"不可改修")).appendTo(r),!t.improvable||t.upgrade_to&&t.upgrade_to.push&&t.upgrade_to.length||$("<span/>").html('<small class="indicator false">不可升级</small>').appendTo(r),t.upgrade_to&&t.upgrade_to.push&&t.upgrade_to.length){var p=$('<div class="stat upgrade"/>').html('<span><small class="indicator true">可升级为</small></span>').appendTo(o);for(var _ in t.upgrade_to)_tmpl.link_equipment(t.upgrade_to[_][0],null,null,t.upgrade_to[_][1]).appendTo(p)}if(t.upgrade_from&&t.upgrade_from.push&&t.upgrade_from.length){var d=$('<div class="stats"/>').html('<h4 data-content="可由以下装备升级获得">可由以下装备升级获得</h4>').appendTo(n),l=$('<div class="stat upgrade"/>').appendTo(d);for(var _ in t.upgrade_from)_tmpl.link_equipment(t.upgrade_from[_]).appendTo(l)}var m=$('<div class="equipped"/>').html('<h4 data-content="初始装备于">初始装备于</h4>').appendTo(n),c=_p.el.flexgrid.create().appendTo(m);if(t.default_equipped_on&&t.default_equipped_on.length)for(var _ in t.default_equipped_on)c.appendDOM(_tmpl.link_ship(t.default_equipped_on[_]).addClass("unit"));else c.addClass("no").html("暂无初始配置该装备的舰娘...");var h=$('<aside class="illustrations"/>').appendTo(n);try{var f=_g.path.pics.items+"/"+t.id+"/card.webp",u=node.fs.lstatSync(f);u&&u.isFile()&&$('<img src="'+f+'" data-filename="'+t.name.zh_cn+'.webp"/>').appendTo(h)}catch(g){}return n},"undefined"!=typeof _p.tip&&(_p.tip.filters.push(function(e){var a=/^\[\[EQUIPMENT\:\:([0-9]+)\]\]$/.exec(e);return a&&a.length>1?_p.tip.content_equipment(_g.data.items[parseInt(a[1])]):void 0}),_p.tip.content_equipment=function(e){function a(a,t){if(!e.stat[a])return"";switch(a){case"range":return"<span>射程: "+_g.getStatRange(e.stat[a])+"</span>";default:var n=parseInt(e.stat[a]);return"<span>"+(n>0?"+":"")+n+" "+t+"</span>"}}var t="assets/images/itemicon/"+_g.data.item_types[e.type].icon+".png",n='<h3 class="itemstat"><s style="background-image: url('+t+')"></s><strong data-content="'+e.name.zh_cn+'">'+e.name.zh_cn+"</strong><small>"+_g.data.item_types[e.type].name.zh_cn+"</small></h3>"+a("fire","火力")+a("torpedo","雷装")+a("aa","对空")+a("asw","对潜")+a("bomb","爆装")+a("hit","命中")+a("armor","装甲")+a("evasion","回避")+a("los","索敌")+a("range","射程");return n}),_p.el.tablelist={init_el:function(e){return e.data("tablelist")?!0:void e.data({tablelist:new _tablelist(e)})},init:function(e,a){e=e||$body,a=a||e.find(".tablelist"),a.each(function(){_p.el.tablelist.init_el($(this))})}};var _tablelist=function(e){this.dom={container:e},e.hasClass("ships")?this.listtype="ships":e.hasClass("equipments")&&(this.listtype="equipments"),this._index=this.global_index,this.global_index++,this.init()};_tablelist.prototype.global_index=0,_tablelist.prototype.flexgrid_empty_count=6,_tablelist.prototype.sort_data_by_stat={},_tablelist.prototype.sort_default_order_by_stat={},_tablelist.prototype._ships_columns=["  ",["火力","fire"],["雷装","torpedo"],["夜战","nightpower"],["对空","aa"],["对潜","asw"],["耐久","hp"],["装甲","armor"],["回避","evasion"],["搭载","carry"],["航速","speed"],["射程","range"],["索敌","los"],["运","luck"],["油耗","consum_fuel"],["弹耗","consum_ammo"]],_tablelist.prototype._ships_header_checkbox=[],_tablelist.prototype._ships_last_item=null,_tablelist.prototype._ships_append_item=function(e,a){function t(e,a){return a||0!=e&&"0"!=e?-1==e||"-1"==e?'<small class="zero">?</small>':e:'<small class="zero">-</small>'}var n=this,s=_g.data.ship_types[e.type].donotcompare?!0:!1,i=$('<tr class="row" data-shipid="'+e.id+'" data-header="'+a+'" data-trindex="'+n.trIndex+'"/>').attr({"data-infos":"[[SHIP::"+e.id+"]]","data-shipedit":n.dom.container.hasClass("shiplist-edit")?"true":null,"data-donotcompare":s?!0:null}).insertAfter(n._ships_last_item),o=0,r=e.name.zh_cn+(e.name.suffix?"<small>"+_g.data.ship_namesuffix[e.name.suffix].zh_cn+"</small>":""),p=$('<input type="checkbox" class="compare"/>').prop("disabled",s).on("click, change",function(e,t){$(this).prop("checked")?i.attr("compare-checked",!0):i.removeAttr("compare-checked"),n._ships_compare_btn_show($(this).prop("checked")),t||n._ships_header_checkbox[a].trigger("docheck")});n._ships_last_item=i,n.trIndex++,n._ships_header_checkbox[a].data("ships",n._ships_header_checkbox[a].data("ships").add(i)),i.data("checkbox",p);for(var _ in e.carry)o+=e.carry[_];for(var _ in n._ships_columns)switch(n._ships_columns[_][1]){case" ":$("<th/>").html('<img src="'+_g.path.pics.ships+"/"+e.id+'/0.webp" contextmenu="disabled"/><strong>'+r+"</strong>").prepend(p).appendTo(i);break;case"nightpower":var d=/^(9|10|11)$/.test(e.type)?0:parseInt(e.stat.fire_max||0)+parseInt(e.stat.torpedo_max||0);$('<td data-stat="nightpower"/>').attr("data-value",-1==d||"-1"==d?null:d).html(t(d)).appendTo(i);break;case"asw":$('<td data-stat="asw" />').attr("data-value",-1==e.stat.asw_max||"-1"==e.stat.asw_max?null:e.stat.asw_max).html(t(e.stat.asw_max,/^(5|8|9|12|24)$/.test(e.type))).appendTo(i);break;case"hp":$('<td data-stat="hp" data-value="'+e.stat.hp+'"/>').html(t(e.stat.hp)).appendTo(i);break;case"carry":$('<td data-stat="carry" data-value="'+e.stat.carry+'"/>').html(t(e.stat.carry)).appendTo(i);break;case"speed":$('<td data-stat="speed" data-value="'+e.stat.speed+'"/>').html(_g.getStatSpeed(e.stat.speed)).appendTo(i);break;case"range":$('<td data-stat="range" data-value="'+e.stat.range+'"/>').html(_g.getStatRange(e.stat.range)).appendTo(i);break;case"luck":$('<td data-stat="luck" data-value="'+e.stat.luck+'"/>').html(e.stat.luck+"<sup>"+e.stat.luck_max+"</sup>").appendTo(i);break;case"consum_fuel":$('<td data-stat="consum_fuel"/>').attr("data-value",-1==e.consum.fuel||"-1"==e.consum.fuel?null:e.consum.fuel).html(t(e.consum.fuel)).appendTo(i);break;case"consum_ammo":$('<td data-stat="consum_ammo"/>').attr("data-value",-1==e.consum.ammo||"-1"==e.consum.ammo?null:e.consum.ammo).html(t(e.consum.ammo)).appendTo(i);break;default:var d=e.stat[n._ships_columns[_][1]+"_max"];$('<td data-stat="'+n._ships_columns[_][1]+'"/>').attr("data-value",-1==d||"-1"==d?-1:d).html(t(d)).appendTo(i)}return e.remodel_next&&_g.data.ships[e.remodel_next]&&_g.ship_type_order_map[e.type]==_g.ship_type_order_map[_g.data.ships[e.remodel_next].type]&&e.name.ja_jp==_g.data.ships[e.remodel_next].name.ja_jp&&i.addClass("premodeled"),i},_tablelist.prototype._ships_append_all_items=function(){function e(t,n){if(_g.data.ship_id_by_type[t]){if(!n){if("object"==typeof _g.ship_type_order[t])var s=_g.data.ship_types[_g.ship_type_order[t][0]];else var s=_g.data.ship_types[_g.ship_type_order[t]];var i="_input_g"+parseInt(_g.inputIndex);a._ships_last_item=$('<tr class="typetitle" data-trindex="'+a.trIndex+'"><th colspan="'+(a._ships_columns.length+1)+'"><label for="'+i+'">'+_g.data.ship_type_order[t].name.zh_cn+(_g.data.ship_type_order[t].name.zh_cn==s.full_zh?"<small>["+s.code+"]</small>":"")+"</label></th></tr>").appendTo(a.dom.tbody),a.trIndex++;for(var o=0;o<a.flexgrid_empty_count;){var r=a.trIndex+_g.data.ship_id_by_type[t].length+o;$('<tr class="empty" data-trindex="'+r+'"/>').appendTo(a.dom.tbody),o++}a._ships_header_checkbox[t]=$('<input type="checkbox" id="'+i+'"/>').prop("disabled",_g.data.ship_type_order[t].donotcompare?!0:!1).on({change:function(){var e=$(this);e.data("ships").filter(":visible").each(function(){$(this).data("checkbox").prop("checked",e.prop("checked")).trigger("change",[!0])})},docheck:function(){var e=$(this).data("ships").filter(":visible"),a=e.filter("[compare-checked=true]");$(this).prop(a.length?a.length<e.length?{checked:!1,indeterminate:!0}:{checked:!0,indeterminate:!1}:{checked:!1,indeterminate:!1})}}).data("ships",$()).prependTo(a._ships_last_item.find("th")),_g.inputIndex++}a._ships_append_item(_g.data.ships[_g.data.ship_id_by_type[t][n]],t),setTimeout(function(){n>=_g.data.ship_id_by_type[t].length-1?(a.trIndex+=a.flexgrid_empty_count,e(t+1,0)):e(t,n+1)},0)}else a.mark_high(),a.thead_redraw(),_frame.app_main.loaded("tablelist_"+a._index,!0),delete a._ships_last_item}var a=this;e(0,0)},_tablelist.prototype._ships_compare_btn_show=function(e){!e&&this.dom.tbody.find('input[type="checkbox"].compare:checked').length||e?this.dom.msg_container.attr("data-msgs","comparestart"):this.dom.msg_container.removeAttr("data-msgs")},_tablelist.prototype._ships_compare_start=function(){this.dom.msg_container.removeAttr("data-msgs"),this._ships_last_viewtype=this.dom.filter_container.attr("viewtype"),_config.set("shiplist-viewtype",this._ships_last_viewtype),this._ships_last_scrollTop=this.dom.table_container_inner.scrollTop(),this.dom.filter_container.attr("viewtype","compare"),this.dom.table_container_inner.scrollTop(0),this.dom.table.addClass("sortable"),this.mark_high(!0),this.thead_redraw(500)},_tablelist.prototype._ships_compare_off=function(){this.dom.filter_container.attr("viewtype",this._ships_last_viewtype),this.sort_table_restore(),this.mark_high(),this.thead_redraw(500),this.dom.table_container_inner.scrollTop(this._ships_last_scrollTop),this.dom.table.removeClass("sortable"),delete this._ships_last_viewtype,delete this._ships_last_scrollTop},_tablelist.prototype._ships_compare_end=function(){this.dom.tbody.find('input[type="checkbox"].compare:checked').prop("checked",!1).trigger("change"),this.dom.msg_container.removeAttr("data-msgs"),this._ships_compare_off()},_tablelist.prototype._ships_compare_continue=function(){this.dom.msg_container.attr("data-msgs","comparestart"),this._ships_compare_off()},_tablelist.prototype._ships_init=function(){function e(e){a.dom.thead=$("<thead/>");var t=$("<tr/>").appendTo(a.dom.thead);for(var n in e)!function(e){if("object"==typeof e)var n=$('<td data-stat="'+e[1]+'"/>').html('<div class="th-inner-wrapper"><span><span>'+e[0]+"</span></span></div>").on("click",function(){a.sort_table_from_theadcell(n)}).appendTo(t);else $("<th/>").html('<div class="th-inner-wrapper"><span><span>'+e[0]+"</span></span></div>").appendTo(t)}(e[n]);return a.dom.thead}var a=this;this.trIndex=0,_frame.app_main.loading.push("tablelist_"+this._index),_frame.app_main.is_loaded=!1,this.dom.filter_container=$('<div class="options"/>').appendTo(this.dom.container),this.dom.filters=$('<div class="filters"/>').appendTo(this.dom.filter_container),this.dom.exit_compare=$('<div class="exit_compare"/>').append($('<button icon="arrow-set2-left"/>').html("结束对比").on("click",function(){a._ships_compare_end()})).append($('<button icon="checkbox-checked"/>').html("继续选择").on("click",function(){a._ships_compare_continue()})).appendTo(this.dom.filter_container),this.dom.btn_compare_sort=$('<button icon="sort-amount-desc" class="disabled"/>').html("点击表格标题可排序").on("click",function(){a.dom.btn_compare_sort.hasClass("disabled")||a.sort_table_restore()}).appendTo(this.dom.exit_compare),this.append_option("checkbox","hide-premodel","仅显示同种同名舰最终版本","false"===_config.get("shiplist-filter-hide-premodel")?null:!0,null,{onchange:function(e,t){_config.set("shiplist-filter-hide-premodel",t.prop("checked")),a.dom.filter_container.attr("filter-hide-premodel",t.prop("checked")),a.thead_redraw()}}),this.append_option("radio","viewtype",null,[["card",""],["list",""]],null,{radio_default:_config.get("shiplist-viewtype"),onchange:function(e,t){t.is(":checked")&&(_config.set("shiplist-viewtype",t.val()),a.dom.filter_container.attr("viewtype",t.val()),a.thead_redraw())}}),this.dom.filters.find("input").trigger("change"),this.dom.table_container=$('<div class="fixed-table-container"/>').appendTo(this.dom.container),this.dom.table_container_inner=$('<div class="fixed-table-container-inner"/>').appendTo(this.dom.table_container),this.dom.table=$('<table class="ships hashover hashover-column"/>').appendTo(this.dom.table_container_inner),e(a._ships_columns).appendTo(this.dom.table),this.dom.tbody=$("<tbody/>").appendTo(this.dom.table),_g.data.ship_types?a._ships_append_all_items():$("<p/>").html("暂无数据...").appendTo(a.dom.table_container_inner),this.dom.msg_container=$('<div class="msgs"/>').appendTo(this.dom.container),_config.get("hide-compareinfos")||this.dom.msg_container.attr("data-msgs","compareinfos");var t=$('<div class="compareinfos"/>').html("点击舰娘查询详细信息，勾选舰娘进行对比").appendTo(this.dom.msg_container);$("<button/>").html("&times;").on("click",function(){a.dom.msg_container.removeAttr("data-msgs"),_config.set("hide-compareinfos",!0)}).appendTo(t);$('<div class="comparestart"/>').html("开始对比").on("click",function(){a._ships_compare_start()}).appendTo(this.dom.msg_container)},_tablelist.prototype._equipments_columns=["  ",["火力","fire"],["雷装","torpedo"],["对空","aa"],["对潜","asw"],["爆装","bomb"],["命中","hit"],["装甲","armor"],["回避","evasion"],["索敌","los"],["射程","range"]],_tablelist.prototype._equipments_append_item=function(e,a){function t(e,a){return a||0!=e&&"0"!==e&&""!==e?e:'<small class="zero">-</small>'}var n=this,s=$('<tr class="row" data-equipmentid="'+e.id+'" data-equipmentcollection="'+a+'"/>').attr({"data-infos":"[[EQUIPMENT::"+e.id+"]]","data-equipmentedit":n.dom.container.hasClass("equipmentlist-edit")?"true":null}).appendTo(this.dom.tbody);for(var i in n._equipments_columns)switch(n._equipments_columns[i][1]){case" ":$("<th/>").html(e.name.zh_cn).appendTo(s);break;case"range":$('<td data-stat="range" data-value="'+e.stat.range+'"/>').html(e.stat.range?_g.getStatRange(e.stat.range):'<small class="zero">-</small>').appendTo(s);break;default:$('<td data-stat="'+n._equipments_columns[i][1]+'" data-value="'+e.stat[n._equipments_columns[i][1]]+'"/>').addClass(e.stat[n._equipments_columns[i][1]]<0?"negative":"").html(t(e.stat[n._equipments_columns[i][1]])).appendTo(s)}return s},_tablelist.prototype._equipments_append_all_items=function(){function e(t,n){if(_g.data.item_id_by_type[t]){if(!n){var s=_g.data.item_types[_g.item_type_order[t]];$('<tr class="typetitle" data-equipmentcollection="'+_g.data.item_id_by_type[t].collection+'"><th colspan="'+(a._equipments_columns.length+1)+'"><span style="background-image: url(../app/assets/images/itemicon/'+s.icon+'.png)"></span>'+s.name.zh_cn+_frame.app_main.page.equipments.gen_helper_equipable_on(s.id)+"</th></tr>").appendTo(a.dom.tbody)}a._equipments_append_item(_g.data.items[_g.data.item_id_by_type[t].equipments[n]],_g.data.item_id_by_type[t].collection),setTimeout(function(){n>=_g.data.item_id_by_type[t].equipments.length-1?e(t+1,0):e(t,n+1)},0)}else a.thead_redraw(),_frame.app_main.loaded("tablelist_"+a._index,!0)}var a=this;e(0,0)},_tablelist.prototype._equipments_init=function(){function e(e){a.dom.thead=$("<thead/>");var t=$("<tr/>").appendTo(a.dom.thead);for(var n in e)"object"==typeof e[n]?$('<td data-stat="'+e[n][1]+'"/>').html('<div class="th-inner-wrapper"><span><span>'+e[n][0]+"</span></span></div>").appendTo(t):$("<th/>").html('<div class="th-inner-wrapper"><span><span>'+e[n][0]+"</span></span></div>").appendTo(t);return a.dom.thead}var a=this;if(!_g.data.item_id_by_type){_g.data.item_id_by_type=[],_g.item_type_order=[];var t={},n={};for(var s in _g.data.item_type_collections)for(var i in _g.data.item_type_collections[s].types)t[_g.data.item_type_collections[s].types[i]]=s,_g.item_type_order.push(_g.data.item_type_collections[s].types[i]),n[_g.data.item_type_collections[s].types[i]]=_g.item_type_order.length-1;for(var s in _g.data.items){var o=n[_g.data.items[s].type];_g.data.item_id_by_type[o]||(_g.data.item_id_by_type[o]={collection:t[_g.data.items[s].type],equipments:[]}),_g.data.item_id_by_type[o].equipments.push(_g.data.items[s].id)}}_frame.app_main.loading.push("tablelist_"+this._index),_frame.app_main.is_loaded=!1,this.dom.filter_container=$('<div class="options"/>').appendTo(this.dom.container),this.dom.filters=$('<div class="filters"/>').appendTo(this.dom.filter_container);var r=!1;for(var s in _g.data.item_type_collections){var p="_input_g"+parseInt(_g.inputIndex);$('<input type="radio" name="equipmentcollection" id="'+p+'" value="'+s+'"/>').prop("checked",!r).on("change",function(){a.thead_redraw()}).prependTo(this.dom.container),$('<label class="tab container" for="'+p+'" data-equipmentcollection="'+s+'"/>').html("<i></i><em></em><span>"+_g.data.item_type_collections[s].name.zh_cn.replace(/\&/g,"<br/>")+"</span>").appendTo(a.dom.filters),r=!0,_g.inputIndex++}this.dom.table_container=$('<div class="fixed-table-container"/>').appendTo(this.dom.container),this.dom.table_container_inner=$('<div class="fixed-table-container-inner"/>').appendTo(this.dom.table_container),this.dom.table=$('<table class="equipments hashover hashover-column"/>').appendTo(this.dom.table_container_inner),e(a._equipments_columns).appendTo(this.dom.table),this.dom.tbody=$("<tbody/>").appendTo(this.dom.table),a._equipments_append_all_items(),this.dom.msg_container=$('<div class="msgs"/>').appendTo(this.dom.container),_config.get("hide-equipmentsinfos")||this.dom.msg_container.attr("data-msgs","equipmentsinfos");var _=$('<div class="equipmentsinfos"/>').html("点击装备查询初装舰娘等信息").appendTo(this.dom.msg_container);$("<button/>").html("&times;").on("click",function(){a.dom.msg_container.removeAttr("data-msgs"),_config.set("hide-equipmentsinfos",!0)}).appendTo(_)},_tablelist.prototype.append_option=function(e,a,t,n,s,i){function o(){switch(e){case"text":case"number":case"hidden":var t=$('<input type="'+e+'" name="'+a+'" id="'+p+'" />').val(n);break;case"select":var t=$('<select name="'+a+'" id="'+p+'" />'),s=$('<option value=""/>').html("").appendTo(t);for(var o in n){if("object"==typeof n[o])var r=$('<option value="'+("undefined"==typeof n[o].val?n[o].value:n[o].val)+'"/>').html(n[o].title||n[o].name).appendTo(t);else var r=$('<option value="'+n[o]+'"/>').html(n[o]).appendTo(t);"undefined"!=typeof i["default"]&&r.val()==i["default"]&&r.prop("selected",!0)}n&&n.length||(s.remove(),$('<option value=""/>').html("...").appendTo(t)),i["new"]&&($('<option value=""/>').html("==========").insertAfter(s),$('<option value="___new___"/>').html("+ 新建").insertAfter(s),t.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),i["new"](t))}));break;case"checkbox":var t=$('<input type="'+e+'" name="'+a+'" id="'+p+'" />').prop("checked",n);break;case"radio":var t=$();for(var o in n){var _,d,l=!1;n[o].push?(d=n[o][0],_=n[o][1]):(d=n[o].val||n[o].value,_=n[o].title||n[o].name),i.radio_default&&i.radio_default==d&&(l=!0),t=t.add($('<input type="radio" name="'+a+'" id="'+p+"-"+d+'" ischecked="'+l+'" />').val(d).prop("checked",l||!l&&0==o)),t=t.add($('<label for="'+p+"-"+d+'"/>').html(_))}}return i.required&&t.prop("required",!0),i.onchange&&(t.on("change.___onchange___",function(e){i.onchange(e,$(this))}),i["default"]&&t.trigger("change")),a||t.attr("name",null),t}i=i||{};var r=$("<p/>").addClass(a).appendTo(this.dom.filters),p="_input_g"+parseInt(_g.inputIndex),t=t?$('<label for="'+p+'"/>').html(t).appendTo(r):null,_=o().appendTo(r);return"checkbox"==e&&t&&t.insertAfter(_),s&&$('<label for="'+p+'"/>').html(s).appendTo(r),_g.inputIndex++,r},_tablelist.prototype.thead_redraw=function(e){if(this.dom.thead&&this.dom.thead.length){var a=this.dom.thead;setTimeout(function(){a.hide().show(0)},e||10)}},_tablelist.prototype.sort_column=function(e,a,t){if(!t){var n=this.dom.tbody;n&&n.length||(n=this.dom.table.find("tbody")),t=n.find("tr.row:visible").not("[data-donotcompare]")}e=e||1,this._tmp_values=[],this._tmp_value_map_cell={};var s=this;t.find("td:nth-of-type("+e+")").each(function(){var e=$(this),a=$(this).data("value");a=parseFloat(a),$.inArray(a,s._tmp_values)<0&&s._tmp_values.push(a),s._tmp_value_map_cell[a]||(s._tmp_value_map_cell[a]=$()),s._tmp_value_map_cell[a]=s._tmp_value_map_cell[a].add(e)}),this._tmp_values.sort(function(e,t){return a?e-t:t-e});var i=[];for(var o in this._tmp_values)i.push(this._tmp_value_map_cell[this._tmp_values[o]]);return delete this._tmp_values,delete this._tmp_value_map_cell,i},_tablelist.prototype.mark_high=function(e){var a=this.dom.tbody;a&&a.length||(a=this.dom.table.find("tbody"));var t=a.find("tr.row:visible").not("[data-donotcompare]"),n=this,s=this.sort_data_by_stat;return t.find("td[data-value]").removeClass("sort-first sort-second"),t.eq(0).find("td[data-value]").each(function(a){var i=!1,o=$(this),r=o.data("stat"),p=r.match(/\b(speed|range)\b/);"undefined"==typeof n.sort_default_order_by_stat[r]?(r.match(/\b(consum_fuel|consum_ammo)\b/)&&(i=!0),n.sort_default_order_by_stat[r]=i?"asc":"desc"):i="asc"==n.sort_default_order_by_stat[r]?!0:!1;var _=_tablelist.prototype.sort_column(a+1,i,t),d=Math.min(6,Math.ceil(t.length/2)+1);!p&&_.length>1&&_[0].length<d&&(_[0].addClass("sort-first"),_.length>2&&_[1].length<d&&_[1].addClass("sort-second")),e?s[r]=_:delete s[r]}),t},_tablelist.prototype.sort_table_from_theadcell=function(e){var a=e.data("stat"),t=this.sort_data_by_stat[a];if(!a||!t)return!1;a!=this.lastSortedStat&&(this.lastSortedHeader&&this.lastSortedHeader.removeClass("sorting desc asc"),e.addClass("sorting"));var n=a==this.lastSortedStat&&"obverse"==this.lastSortedOrder?"reverse":"obverse",s="reverse"==n?t.length-1:0;if(this.sort_default_order_by_stat[a]){var i="asc"==this.sort_default_order_by_stat[a]?"desc":"asc";"obverse"==n?e.removeClass(i).addClass(this.sort_default_order_by_stat[a]):e.removeClass(this.sort_default_order_by_stat[a]).addClass(i)}for(this.sortedRow=$();t[s];)this._tmpDOM=t[s].parent(),this.sortedRow=this.sortedRow.add(this._tmpDOM),this._tmpDOM.appendTo(this.dom.tbody),s="reverse"==n?s-1:s+1;this.dom.btn_compare_sort.removeClass("disabled").html("取消排序"),this.lastSortedStat=a,this.lastSortedOrder=n,this.lastSortedHeader=e,delete this._tmpDOM},_tablelist.prototype.sort_table_restore=function(){if(!this.sortedRow)return!0;var e,a=[];this.sortedRow.each(function(){var t=$(this),n=parseInt(t.data("trindex"));e=e||t.parent(),a.push({index:n,el:t,prev:e.children('tr[data-trindex="'+(n-1)+'"]')})}),a.sort(function(e,a){return e.index-a.index});for(var t in a)a[t].el.insertAfter(a[t].prev);return this.dom.btn_compare_sort.addClass("disabled").html("点击表格标题可排序"),this.lastSortedHeader.removeClass("sorting desc asc"),delete this.sortedRow,delete this.lastSortedStat,delete this.lastSortedOrder,delete this.lastSortedHeader,!0},_tablelist.prototype.init=function(){return this.is_init?!0:(this["_"+this.listtype+"_init"]&&this["_"+this.listtype+"_init"](),void(this.is_init=!0))};